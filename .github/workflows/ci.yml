# ==============================================================================
# MachineNativeOps CI Pipeline
# å®Œæ•´çš„æŒçºŒé›†æˆæµæ°´ç·š - ä»£ç¢¼å“è³ªã€å®‰å…¨ã€æ¸¬è©¦
# ==============================================================================
name: "ğŸš€ CI Pipeline"

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

# ä¸¦ç™¼æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  packages: write
  checks: write
  pull-requests: write

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  GO_VERSION: "1.21"
  JAVA_VERSION: "17"
  DOCKER_REGISTRY: "ghcr.io"
  IMAGE_NAME: "machinenativeops"

jobs:
  # =============================================================================
  # ä»£ç¢¼å“è³ªæª¢æŸ¥
  # =============================================================================
  code-quality:
    name: "ğŸ” Code Quality Analysis"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: actions/checkout@0ad4b8f3a27c304e21892351cbf9860471245599  # v4
        with:
          fetch-depth: 0

      - name: "è¨­ç½® Python ç’°å¢ƒ"
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d534527d238d7a7  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: "è¨­ç½® Node.js ç’°å¢ƒ"
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b  # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "å®‰è£ä»£ç¢¼å“è³ªå·¥å…·"
        run: |
          pip install --user pylint black flake8 mypy bandit safety
          npm install -g eslint prettier @typescript-eslint/parser
          
      - name: "Python ä»£ç¢¼æª¢æŸ¥"
        run: |
          echo "ğŸ” åŸ·è¡Œ Python ä»£ç¢¼å“è³ªæª¢æŸ¥..."
          find . -name "*.py" -type f ! -path "*/node_modules/*" ! -path "*/.git/*" > python_files.txt
          
          if [ -s python_files.txt ]; then
            echo "ğŸ“Š ç™¼ç¾ $(wc -l < python_files.txt) å€‹ Python æ–‡ä»¶"
            
            # Pylint æª¢æŸ¥
            echo "ğŸ” åŸ·è¡Œ Pylint æª¢æŸ¥..."
            pylint --disable=C0114,C0115,C0116 --score=no $(cat python_files.txt) || true
            
            # Black æ ¼å¼æª¢æŸ¥
            echo "ğŸ¨ æª¢æŸ¥ä»£ç¢¼æ ¼å¼..."
            black --check --diff $(cat python_files.txt) || echo "âš ï¸ Black æª¢æŸ¥ç™¼ç¾æ ¼å¼å•é¡Œ"
            
            # Flake8 æª¢æŸ¥
            echo "ğŸ” åŸ·è¡Œ Flake8 æª¢æŸ¥..."
            flake8 --max-line-length=100 --ignore=E203,W503 $(cat python_files.txt) || true
            
            # MyPy é¡å‹æª¢æŸ¥
            echo "ğŸ” åŸ·è¡Œ MyPy é¡å‹æª¢æŸ¥..."
            mypy --ignore-missing-imports --no-strict-optional $(cat python_files.txt) || true
          else
            echo "â„¹ï¸ æœªç™¼ç¾ Python æ–‡ä»¶"
          fi

      - name: "JavaScript/TypeScript ä»£ç¢¼æª¢æŸ¥"
        run: |
          echo "ğŸ” åŸ·è¡Œ JavaScript/TypeScript ä»£ç¢¼å“è³ªæª¢æŸ¥..."
          find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -v node_modules > js_files.txt
          
          if [ -s js_files.txt ]; then
            echo "ğŸ“Š ç™¼ç¾ $(wc -l < js_files.txt) å€‹ JS/TS æ–‡ä»¶"
            
            # ESLint æª¢æŸ¥
            echo "ğŸ” åŸ·è¡Œ ESLint æª¢æŸ¥..."
            eslint $(cat js_files.txt) || echo "âš ï¸ ESLint æª¢æŸ¥ç™¼ç¾å•é¡Œ"
            
            # Prettier æ ¼å¼æª¢æŸ¥
            echo "ğŸ¨ æª¢æŸ¥ä»£ç¢¼æ ¼å¼..."
            prettier --check $(cat js_files.txt) || echo "âš ï¸ Prettier æª¢æŸ¥ç™¼ç¾æ ¼å¼å•é¡Œ"
          else
            echo "â„¹ï¸ æœªç™¼ç¾ JavaScript/TypeScript æ–‡ä»¶"
          fi

      - name: "ç”Ÿæˆä»£ç¢¼å“è³ªå ±å‘Š"
        run: |
          echo "# ğŸ“Š Code Quality Report" > code-quality-report.md
          echo "" >> code-quality-report.md
          echo "**æª¢æŸ¥æ™‚é–“**: $(date)" >> code-quality-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> code-quality-report.md
          echo "" >> code-quality-report.md
          
          # çµ±è¨ˆæ–‡ä»¶æ•¸é‡
          PY_COUNT=$(find . -name "*.py" -type f ! -path "*/node_modules/*" | wc -l)
          JS_COUNT=$(find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -v node_modules | wc -l)
          
          echo "## ğŸ“ˆ ä»£ç¢¼çµ±è¨ˆ" >> code-quality-report.md
          echo "- Python æ–‡ä»¶: $PY_COUNT" >> code-quality-report.md
          echo "- JavaScript/TypeScript æ–‡ä»¶: $JS_COUNT" >> code-quality-report.md
          echo "" >> code-quality-report.md
          
          echo "## ğŸ” æª¢æŸ¥çµæœ" >> code-quality-report.md
          echo "âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥å·²å®Œæˆ" >> code-quality-report.md
          
          cat code-quality-report.md

      - name: "ä¸Šå‚³å“è³ªå ±å‘Š"
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808  # v4
        with:
          name: code-quality-report
          path: code-quality-report.md
          retention-days: 30

  # =============================================================================
  # å®‰å…¨æ¼æ´æƒæ
  # =============================================================================
  security-scan:
    name: "ğŸ”’ Security Vulnerability Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: actions/checkout@0ad4b8f3a27c304e21892351cbf9860471245599  # v4

      - name: "è¨­ç½® Python ç’°å¢ƒ"
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d534527d238d7a7  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "å®‰è£å®‰å…¨æƒæå·¥å…·"
        run: |
          pip install --user safety bandit semgrep
          npm install -g audit-ci snyk

      - name: "Python ä¾è³´å®‰å…¨æƒæ"
        run: |
          echo "ğŸ”’ æƒæ Python ä¾è³´æ¼æ´..."
          find . -name "requirements.txt" -o -name "setup.py" -o -name "pyproject.toml" | grep -v node_modules > requirements_files.txt
          
          if [ -s requirements_files.txt ]; then
            for req_file in $(cat requirements_files.txt); do
              echo "ğŸ“‹ æª¢æŸ¥æ–‡ä»¶: $req_file"
              if [ -f "$req_file" ]; then
                safety check -r "$req_file" --json --output safety-report.json || echo "âš ï¸ Safety ç™¼ç¾æ½›åœ¨å•é¡Œ"
              fi
            done
          else
            echo "â„¹ï¸ æœªç™¼ç¾ Python ä¾è³´æ–‡ä»¶"
          fi

      - name: "Python ä»£ç¢¼å®‰å…¨æƒæ"
        run: |
          echo "ğŸ” åŸ·è¡Œ Bandit å®‰å…¨æƒæ..."
          find . -name "*.py" -type f ! -path "*/node_modules/*" ! -path "*/.git/*" > python_files.txt
          
          if [ -s python_files.txt ]; then
            bandit -r $(dirname $(head -1 python_files.txt)) -f json -o bandit-report.json || echo "âš ï¸ Bandit ç™¼ç¾æ½›åœ¨å®‰å…¨å•é¡Œ"
          fi

      - name: "Semgrep ä»£ç¢¼åˆ†æ"
        run: |
          echo "ğŸ” åŸ·è¡Œ Semgrep ä»£ç¢¼åˆ†æ..."
          semgrep --config=auto --json --output=semgrep-report.json . || echo "âš ï¸ Semgrep åˆ†æå®Œæˆ"

      - name: "Node.js ä¾è³´å®‰å…¨æƒæ"
        run: |
          echo "ğŸ”’ æƒæ Node.js ä¾è³´æ¼æ´..."
          find . -name "package.json" | grep -v node_modules > package_files.txt
          
          if [ -s package_files.txt ]; then
            for pkg_file in $(cat package_files.txt); do
              pkg_dir=$(dirname "$pkg_file")
              echo "ğŸ“‹ æª¢æŸ¥ç›®éŒ„: $pkg_dir"
              cd "$pkg_dir"
              npm audit --audit-level moderate --json > ../npm-audit-report.json || echo "âš ï¸ npm audit ç™¼ç¾å•é¡Œ"
              cd - > /dev/null
            done
          else
            echo "â„¹ï¸ æœªç™¼ç¾ Node.js ä¾è³´æ–‡ä»¶"
          fi

      - name: "ç”Ÿæˆå®‰å…¨å ±å‘Š"
        run: |
          echo "# ğŸ”’ Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**æƒææ™‚é–“**: $(date)" >> security-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          
          echo "## ğŸ›¡ï¸ å®‰å…¨æƒæçµæœ" >> security-report.md
          echo "âœ… å®‰å…¨æƒæå·²å®Œæˆ" >> security-report.md
          echo "" >> security-report.md
          
          echo "### ğŸ“‹ æƒæé …ç›®" >> security-report.md
          echo "- Python ä¾è³´æ¼æ´æƒæ (Safety)" >> security-report.md
          echo "- Python ä»£ç¢¼å®‰å…¨æƒæ (Bandit)" >> security-report.md
          echo "- ä»£ç¢¼éœæ…‹åˆ†æ (Semgrep)" >> security-report.md
          echo "- Node.js ä¾è³´æƒæ (npm audit)" >> security-report.md
          
          cat security-report.md

      - name: "ä¸Šå‚³å®‰å…¨å ±å‘Š"
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808  # v4
        with:
          name: security-scan-report
          path: |
            security-report.md
            safety-report.json
            bandit-report.json
            semgrep-report.json
            npm-audit-report.json
          retention-days: 30

  # =============================================================================
  # å–®å…ƒæ¸¬è©¦
  # =============================================================================
  unit-tests:
    name: "ğŸ§ª Unit Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ["3.9", "3.11", "3.12"]
    
    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: actions/checkout@0ad4b8f3a27c304e21892351cbf9860471245599  # v4

      - name: "è¨­ç½® Python ${{ matrix.python-version }}"
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d534527d238d7a7  # v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: "å®‰è£æ¸¬è©¦ä¾è³´"
        run: |
          pip install --user pytest pytest-cov pytest-xdist pytest-mock coverage

      - name: "åŸ·è¡Œå–®å…ƒæ¸¬è©¦"
        run: |
          echo "ğŸ§ª åŸ·è¡Œ Python å–®å…ƒæ¸¬è©¦..."
          
          # æŸ¥æ‰¾æ¸¬è©¦æ–‡ä»¶
          find . -name "test_*.py" -o -name "*_test.py" ! -path "*/node_modules/*" > test_files.txt
          
          if [ -s test_files.txt ]; then
            echo "ğŸ“Š ç™¼ç¾ $(wc -l < test_files.txt) å€‹æ¸¬è©¦æ–‡ä»¶"
            
            # åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
            pytest \
              --verbose \
              --tb=short \
              --cov=. \
              --cov-report=xml \
              --cov-report=html \
              --cov-report=term-missing \
              --junit-xml=test-results.xml \
              $(dirname $(head -1 test_files.txt)) || echo "âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—"
          else
            echo "â„¹ï¸ æœªç™¼ç¾æ¸¬è©¦æ–‡ä»¶"
          fi

      - name: "ç”Ÿæˆæ¸¬è©¦å ±å‘Š"
        if: always()
        run: |
          echo "# ğŸ§ª Unit Test Report" > test-report.md
          echo "" >> test-report.md
          echo "**æ¸¬è©¦æ™‚é–“**: $(date)" >> test-report.md
          echo "**Python ç‰ˆæœ¬**: ${{ matrix.python-version }}" >> test-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> test-report.md
          echo "" >> test-report.md
          
          if [ -f "test-results.xml" ]; then
            echo "## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ" >> test-report.md
            # è§£æ JUnit XML çµ±è¨ˆä¿¡æ¯
            TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            
            echo "- ç¸½æ¸¬è©¦æ•¸: $TESTS" >> test-report.md
            echo "- å¤±æ•—æ•¸: $FAILURES" >> test-report.md
            echo "- éŒ¯èª¤æ•¸: $ERRORS" >> test-report.md
            
            if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
              echo "- ç‹€æ…‹: âœ… å…¨éƒ¨é€šé" >> test-report.md
            else
              echo "- ç‹€æ…‹: âŒ éƒ¨åˆ†å¤±æ•—" >> test-report.md
            fi
          else
            echo "â„¹ï¸ æœªç”Ÿæˆæ¸¬è©¦çµæœæ–‡ä»¶" >> test-report.md
          fi
          
          cat test-report.md

      - name: "ä¸Šå‚³æ¸¬è©¦å ±å‘Š"
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808  # v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-report.md
            test-results.xml
            htmlcov/
            coverage.xml
          retention-days: 30

  # =============================================================================
  # é›†æˆæ¸¬è©¦
  # =============================================================================
  integration-tests:
    name: "ğŸ”— Integration Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [code-quality, security-scan]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: "æª¢å‡ºä»£ç¢¼"
        uses: actions/checkout@0ad4b8f3a27c304e21892351cbf9860471245599  # v4

      - name: "è¨­ç½® Python ç’°å¢ƒ"
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d534527d238d7a7  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "å®‰è£é›†æˆæ¸¬è©¦ä¾è³´"
        run: |
          pip install --user pytest docker-compose requests

      - name: "åŸ·è¡Œé›†æˆæ¸¬è©¦"
        run: |
          echo "ğŸ”— åŸ·è¡Œé›†æˆæ¸¬è©¦..."
          
          # è¨­ç½®æ¸¬è©¦ç’°å¢ƒè®Šé‡
          export DATABASE_URL="postgresql://postgres:testpass@localhost:5432/testdb"
          export REDIS_URL="redis://localhost:6379"
          export TEST_ENV="integration"
          
          # æŸ¥æ‰¾é›†æˆæ¸¬è©¦æ–‡ä»¶
          find . -name "*integration*" -name "test_*.py" -o -name "*integration*" -name "*_test.py" > integration_test_files.txt
          
          if [ -s integration_test_files.txt ]; then
            echo "ğŸ“Š ç™¼ç¾ $(wc -l < integration_test_files.txt) å€‹é›†æˆæ¸¬è©¦æ–‡ä»¶"
            
            # åŸ·è¡Œé›†æˆæ¸¬è©¦
            pytest \
              --verbose \
              --tb=short \
              --junit-xml=integration-test-results.xml \
              $(dirname $(head -1 integration_test_files.txt)) || echo "âš ï¸ éƒ¨åˆ†é›†æˆæ¸¬è©¦å¤±æ•—"
          else
            echo "â„¹ï¸ æœªç™¼ç¾é›†æˆæ¸¬è©¦æ–‡ä»¶"
          fi

      - name: "ç”Ÿæˆé›†æˆæ¸¬è©¦å ±å‘Š"
        if: always()
        run: |
          echo "# ğŸ”— Integration Test Report" > integration-test-report.md
          echo "" >> integration-test-report.md
          echo "**æ¸¬è©¦æ™‚é–“**: $(date)" >> integration-test-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> integration-test-report.md
          echo "" >> integration-test-report.md
          
          if [ -f "integration-test-results.xml" ]; then
            echo "## ğŸ”— é›†æˆæ¸¬è©¦çµ±è¨ˆ" >> integration-test-report.md
            # è§£æ JUnit XML çµ±è¨ˆä¿¡æ¯
            TESTS=$(grep -o 'tests="[0-9]*"' integration-test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' integration-test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' integration-test-results.xml | head -1 | cut -d'"' -f2 || echo "0")
            
            echo "- ç¸½æ¸¬è©¦æ•¸: $TESTS" >> integration-test-report.md
            echo "- å¤±æ•—æ•¸: $FAILURES" >> integration-test-report.md
            echo "- éŒ¯èª¤æ•¸: $ERRORS" >> integration-test-report.md
            
            if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
              echo "- ç‹€æ…‹: âœ… å…¨éƒ¨é€šé" >> integration-test-report.md
            else
              echo "- ç‹€æ…‹: âŒ éƒ¨åˆ†å¤±æ•—" >> integration-test-report.md
            fi
          else
            echo "â„¹ï¸ æœªç”Ÿæˆé›†æˆæ¸¬è©¦çµæœæ–‡ä»¶" >> integration-test-report.md
          fi
          
          cat integration-test-report.md

      - name: "ä¸Šå‚³é›†æˆæ¸¬è©¦å ±å‘Š"
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808  # v4
        if: always()
        with:
          name: integration-test-results
          path: |
            integration-test-report.md
            integration-test-results.xml
          retention-days: 30

  # =============================================================================
  # CI ç¸½çµå ±å‘Š
  # =============================================================================
  ci-summary:
    name: "ğŸ“‹ CI Summary Report"
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, unit-tests, integration-tests]
    if: always()
    
    steps:
      - name: "ä¸‹è¼‰æ‰€æœ‰å ±å‘Š"
        uses: actions/download-artifact@6b208ae046db98c579e8a328f74b955651f427c0  # v4
        with:
          merge-multiple: true

      - name: "ç”ŸæˆCIç¸½çµå ±å‘Š"
        run: |
          echo "# ğŸš€ CI Pipeline Summary Report" > ci-summary-report.md
          echo "" >> ci-summary-report.md
          echo "**ç”Ÿæˆæ™‚é–“**: $(date)" >> ci-summary-report.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> ci-summary-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> ci-summary-report.md
          echo "**PR**: #${{ github.event.pull_request.number || 'N/A' }}" >> ci-summary-report.md
          echo "" >> ci-summary-report.md
          
          echo "## ğŸ“Š Pipeline ç‹€æ…‹" >> ci-summary-report.md
          echo "- ğŸ” ä»£ç¢¼å“è³ªæª¢æŸ¥: ${{ needs.code-quality.result }}" >> ci-summary-report.md
          echo "- ğŸ”’ å®‰å…¨æƒæ: ${{ needs.security-scan.result }}" >> ci-summary-report.md
          echo "- ğŸ§ª å–®å…ƒæ¸¬è©¦: ${{ needs.unit-tests.result }}" >> ci-summary-report.md
          echo "- ğŸ”— é›†æˆæ¸¬è©¦: ${{ needs.integration-tests.result }}" >> ci-summary-report.md
          echo "" >> ci-summary-report.md
          
          # åˆ¤æ–·æ•´é«”ç‹€æ…‹
          if [ "${{ needs.code-quality.result }}" = "success" ] && \
             [ "${{ needs.security-scan.result }}" = "success" ] && \
             [ "${{ needs.unit-tests.result }}" = "success" ] && \
             [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "## âœ… æ•´é«”ç‹€æ…‹: é€šé" >> ci-summary-report.md
            echo "ğŸ‰ æ‰€æœ‰ CI æª¢æŸ¥éƒ½å·²é€šéï¼" >> ci-summary-report.md
          else
            echo "## âŒ æ•´é«”ç‹€æ…‹: å¤±æ•—" >> ci-summary-report.md
            echo "âš ï¸ éƒ¨åˆ† CI æª¢æŸ¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°å ±å‘Šã€‚" >> ci-summary-report.md
          fi
          
          echo "" >> ci-summary-report.md
          echo "## ğŸ“‹ è©³ç´°å ±å‘Š" >> ci-summary-report.md
          echo "- [ä»£ç¢¼å“è³ªå ±å‘Š](code-quality-report.md)" >> ci-summary-report.md
          echo "- [å®‰å…¨æƒæå ±å‘Š](security-report.md)" >> ci-summary-report.md
          echo "- [å–®å…ƒæ¸¬è©¦å ±å‘Š](test-report.md)" >> ci-summary-report.md
          echo "- [é›†æˆæ¸¬è©¦å ±å‘Š](integration-test-report.md)" >> ci-summary-report.md
          
          cat ci-summary-report.md

      - name: "è©•è«–PRï¼ˆå¦‚æœæœ‰å¤±æ•—ï¼‰"
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7
        with:
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('ci-summary-report.md')) {
              const report = fs.readFileSync('ci-summary-report.md', 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: "ä¸Šå‚³ç¸½çµå ±å‘Š"
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808  # v4
        with:
          name: ci-summary-report
          path: ci-summary-report.md
          retention-days: 30