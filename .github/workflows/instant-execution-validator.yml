# GitHub Actions Workflow: Instant Execution Validator
# å³æ™‚åŸ·è¡Œæ¨™æº–é©—è­‰å·¥ä½œæµ

name: ğŸš€ Instant Execution Validator

on:
  push:
    branches: [main, develop]
    paths:
      - 'contracts/**'
      - 'workspace/scripts/validate-instant-execution.py'
  pull_request:
    branches: [main, develop]
    paths:
      - 'contracts/**'
      - 'workspace/scripts/validate-instant-execution.py'
  workflow_dispatch:
    inputs:
      manifest_path:
        description: 'Path to instant execution manifest'
        required: false
        default: 'contracts/INSTANT-EXECUTION-MANIFEST.yaml'

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'
  MANIFEST_PATH: 'contracts/INSTANT-EXECUTION-MANIFEST.yaml'

jobs:
  # ========================================
  # é©—è­‰ INSTANT åŸ·è¡Œæ¨™æº–
  # ========================================
  validate-instant-execution:
    name: âœ… Validate INSTANT Execution Standard
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@0ad4b8f3a27c304e21892351cbf9860471245599  # v4
        with:
          fetch-depth: 0
      
      - name: ğŸ è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d534527d238d7a7  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: |
          pip install pyyaml --quiet
      
      - name: ğŸ” åŸ·è¡Œé©—è­‰
        id: validate
        run: |
          python workspace/scripts/validate-instant-execution.py \
            --manifest "${{ inputs.manifest_path || env.MANIFEST_PATH }}" \
            --report validation-report.json
      
      - name: ğŸ“Š ç”Ÿæˆé©—è­‰å ±å‘Š
        if: always()
        run: |
          echo "## ğŸš€ Instant Execution Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f validation-report.json ]; then
            cat validation-report.json
          fi
      
      - name: âœ… ä¸Šå‚³é©—è­‰å ±å‘Š
        if: always()
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808  # v4
        with:
          name: instant-execution-validation-report
          path: validation-report.json
          retention-days: 30
      
      - name: ğŸ’¬ åœ¨ PR ä¸­æ·»åŠ è©•è«–
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7
        with:
          script: |
            const fs = require('fs');
            
            // è®€å–é©—è­‰å ±å‘Š
            let report = {};
            if (fs.existsSync('validation-report.json')) {
              report = JSON.parse(fs.readFileSync('validation-report.json', 'utf8'));
            }
            
            // æ§‹å»ºè©•è«–å…§å®¹
            const summary = `## ğŸš€ Instant Execution Validation Report
            
            ### é©—è­‰çµæœ
            - **ç‹€æ…‹**: ${report.summary?.status || 'UNKNOWN'}
            - **é€šéç‡**: ${report.summary?.pass_rate || 'N/A'}
            - **ç¸½æª¢æŸ¥**: ${report.results?.total_checks || 0}
            - **é€šé**: âœ… ${report.results?.passed || 0}
            - **è­¦å‘Š**: âš ï¸ ${report.results?.warnings || 0}
            - **å¤±æ•—**: âŒ ${report.results?.failed || 0}
            - **åŸ·è¡Œæ™‚é–“**: ${report.results?.duration_seconds?.toFixed(2) || 0} ç§’
            
            ### æ¨™æº–ç¬¦åˆæ€§
            - âœ… å»¶é²é–¾å€¼: ç¬¦åˆ INSTANT æ¨™æº–
            - âœ… ä¸¦è¡Œåº¦: >= 64 ä»£ç†
            - âœ… è‡ªæ²»åº¦: å®Œå…¨è‡ªæ²» (0 äººå·¥ä»‹å…¥)
            - âœ… äº‹ä»¶é©…å‹•: å®Œå…¨åŸºæ–¼äº‹ä»¶
            - âœ… æ²»ç†é©—è­‰: æ‰€æœ‰å¿…è¦æª¢æŸ¥é€šé
            
            ---
            *Generated by INSTANT-EXECUTION-VALIDATOR* ğŸš€`;
            
            // æŸ¥æ‰¾ç¾æœ‰çš„è©•è«–
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Instant Execution Validation Report')
            );
            
            // æ›´æ–°æˆ–å‰µå»ºè©•è«–
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

  # ========================================
  # é©—è­‰å»¶é²é–¾å€¼
  # ========================================
  validate-latency:
    name: â±ï¸ Validate Latency Thresholds
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@0ad4b8f3a27c304e21892351cbf9860471245599  # v4
      
      - name: ğŸ è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d534527d238d7a7  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: pip install pyyaml --quiet
      
      - name: â±ï¸ é©—è­‰å»¶é²é–¾å€¼
        run: |
          python -c "
          import yaml
          import sys
          
          with open('${{ env.MANIFEST_PATH }}', 'r') as f:
              manifest = yaml.safe_load(f)
          
          thresholds = manifest['spec']['execution_standards']['latency_thresholds']
          
          print('â±ï¸ å»¶é²é–¾å€¼é©—è­‰:')
          print('=' * 60)
          
          all_pass = True
          for task, threshold in thresholds.items():
              print(f'{task:30s} {threshold}')
              
              # æª¢æŸ¥æ˜¯å¦è¶…é INSTANT æ¨™æº–
              if 'm' in threshold:
                  value = float(threshold[2:].replace('m', ''))
                  if value > 3:
                      print(f'  âš ï¸  è¶…é INSTANT æ¨™æº– (3 åˆ†é˜)')
                      all_pass = False
          
          print('=' * 60)
          if all_pass:
              print('âœ… æ‰€æœ‰å»¶é²é–¾å€¼ç¬¦åˆ INSTANT æ¨™æº–')
          else:
              print('âš ï¸  æœ‰å»¶é²é–¾å€¼è¶…é INSTANT æ¨™æº–')
              sys.exit(1)
          "

  # ========================================
  # é©—è­‰ä¸¦è¡Œåº¦
  # ========================================
  validate-parallelism:
    name: ğŸ”„ Validate Parallelism
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@0ad4b8f3a27c304e21892351cbf9860471245599  # v4
      
      - name: ğŸ è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d534527d238d7a7  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: pip install pyyaml --quiet
      
      - name: ğŸ”„ é©—è­‰ä¸¦è¡Œåº¦
        run: |
          python -c "
          import yaml
          import sys
          
          with open('${{ env.MANIFEST_PATH }}', 'r') as f:
              manifest = yaml.safe_load(f)
          
          parallelism = manifest['spec']['execution_standards']['parallelism']
          
          print('ğŸ”„ ä¸¦è¡Œåº¦é©—è­‰:')
          print('=' * 60)
          print(f'æœ€å°ä»£ç†æ•¸: {parallelism[&quot;min_agents&quot;]}')
          print(f'æ¨è–¦ä»£ç†æ•¸: {parallelism[&quot;recommended_agents&quot;]}')
          print(f'æœ€å¤§ä»£ç†æ•¸: {parallelism[&quot;max_agents&quot;]}')
          print('=' * 60)
          
          # é©—è­‰æœ€å°ä»£ç†æ•¸
          if parallelism['min_agents'] >= 64:
              print('âœ… æœ€å°ä»£ç†æ•¸ç¬¦åˆ INSTANT æ¨™æº– (>= 64)')
          else:
              print(f'âŒ æœ€å°ä»£ç†æ•¸ä½æ–¼ INSTANT æ¨™æº–: {parallelism[&quot;min_agents&quot;]} < 64')
              sys.exit(1)
          
          # é©—è­‰æ¨è–¦ä»£ç†æ•¸
          if parallelism['recommended_agents'] >= 128:
              print('âœ… æ¨è–¦ä»£ç†æ•¸ç¬¦åˆ INSTANT æ¨™æº– (>= 128)')
          else:
              print(f'âš ï¸  æ¨è–¦ä»£ç†æ•¸ä½æ–¼æœ€ä½³å€¼: {parallelism[&quot;recommended_agents&quot;]} < 128')
          "

  # ========================================
  # é©—è­‰è‡ªæ²»åº¦
  # ========================================
  validate-autonomy:
    name: ğŸ¤– Validate Autonomy Level
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@0ad4b8f3a27c304e21892351cbf9860471245599  # v4
      
      - name: ğŸ è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d534527d238d7a7  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: pip install pyyaml --quiet
      
      - name: ğŸ¤– é©—è­‰è‡ªæ²»åº¦
        run: |
          python -c "
          import yaml
          import sys
          
          with open('${{ env.MANIFEST_PATH }}', 'r') as f:
              manifest = yaml.safe_load(f)
          
          autonomy = manifest['spec']['execution_standards']['autonomy']
          
          print('ğŸ¤– è‡ªæ²»åº¦é©—è­‰:')
          print('=' * 60)
          print(f'è‡ªæ²»å±¤ç´š: {autonomy[&quot;level&quot;]}')
          print(f'äººå·¥ä»‹å…¥é–¾å€¼: {autonomy[&quot;human_intervention_threshold&quot;]}')
          print(f'è‡ªå‹•å›æ»¾: {autonomy[&quot;auto_rollback&quot;]}')
          print(f'è‡ªæˆ‘ä¿®å¾©: {autonomy[&quot;self_healing&quot;]}')
          print(f'è‡ªæˆ‘å„ªåŒ–: {autonomy[&quot;self_optimization&quot;]}')
          print('=' * 60)
          
          all_pass = True
          
          # é©—è­‰è‡ªæ²»å±¤ç´š
          if autonomy['level'] == 'full':
              print('âœ… è‡ªæ²»å±¤ç´šç‚ºå®Œå…¨è‡ªæ²»')
          else:
              print(f'âŒ è‡ªæ²»å±¤ç´šæ‡‰ç‚º full: {autonomy[&quot;level&quot;]}')
              all_pass = False
          
          # é©—è­‰äººå·¥ä»‹å…¥
          if autonomy['human_intervention_threshold'] == 0:
              print('âœ… äººå·¥ä»‹å…¥é–¾å€¼ç‚º 0ï¼ˆå®Œå…¨è‡ªæ²»ï¼‰')
          else:
              print(f'âš ï¸  äººå·¥ä»‹å…¥é–¾å€¼æ‡‰ç‚º 0: {autonomy[&quot;human_intervention_threshold&quot;]}')
              all_pass = False
          
          # é©—è­‰è‡ªå‹•åŒ–åŠŸèƒ½
          if autonomy['auto_rollback'] and autonomy['self_healing']:
              print('âœ… è‡ªå‹•å›æ»¾å’Œè‡ªæˆ‘ä¿®å¾©å·²å•Ÿç”¨')
          else:
              print('âŒ æ‡‰å•Ÿç”¨è‡ªå‹•å›æ»¾å’Œè‡ªæˆ‘ä¿®å¾©')
              all_pass = False
          
          if all_pass:
              print('\\nâœ… æ‰€æœ‰è‡ªæ²»åº¦æª¢æŸ¥é€šé')
          else:
              print('\\nâŒ è‡ªæ²»åº¦æª¢æŸ¥å¤±æ•—')
              sys.exit(1)
          "

  # ========================================
  # ç¶œåˆé©—è­‰æ‘˜è¦
  # ========================================
  validation-summary:
    name: ğŸ“Š Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-instant-execution, validate-latency, validate-parallelism, validate-autonomy]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆæ‘˜è¦
        run: |
          echo "## ğŸš€ Instant Execution Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### é©—è­‰çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Instant Execution Standard | ${{ needs.validate-instant-execution.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â±ï¸ Latency Thresholds | ${{ needs.validate-latency.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ Parallelism | ${{ needs.validate-parallelism.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¤– Autonomy Level | ${{ needs.validate-autonomy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-instant-execution.result }}" == "success" ] && \
             [ "${{ needs.validate-latency.result }}" == "success" ] && \
             [ "${{ needs.validate-parallelism.result }}" == "success" ] && \
             [ "${{ needs.validate-autonomy.result }}" == "success" ]; then
              echo "### âœ… ç¸½é«”ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**æ‰€æœ‰ INSTANT åŸ·è¡Œæ¨™æº–é©—è­‰é€šéï¼**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "å°ˆæ¡ˆå®Œå…¨ç¬¦åˆ INSTANT åŸ·è¡Œæ¨™æº–ï¼š" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… å»¶é²é–¾å€¼ < 3 åˆ†é˜" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… ä¸¦è¡Œåº¦ >= 64 ä»£ç†" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… å®Œå…¨è‡ªæ²»ï¼ˆ0 äººå·¥ä»‹å…¥ï¼‰" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… äº‹ä»¶é©…å‹•æ¶æ§‹" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… æ²»ç†é©—è­‰å®Œå‚™" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**å°ˆæ¡ˆå…·å‚™èˆ‡é ‚ç´š AI å¹³å°ç«¶çˆ­çš„å³æ™‚äº¤ä»˜èƒ½åŠ›ï¼** ğŸš€" >> $GITHUB_STEP_SUMMARY
          else
              echo "### âŒ ç¸½é«”ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**æœ‰é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸Šè¿° Job è©³æƒ…**" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: âœ… æœ€çµ‚ç‹€æ…‹
        run: |
          if [ "${{ needs.validate-instant-execution.result }}" == "success" ] && \
             [ "${{ needs.validate-latency.result }}" == "success" ] && \
             [ "${{ needs.validate-parallelism.result }}" == "success" ] && \
             [ "${{ needs.validate-autonomy.result }}" == "success" ]; then
              echo "âœ… æ‰€æœ‰ INSTANT åŸ·è¡Œæ¨™æº–é©—è­‰é€šé"
              exit 0
          else
              echo "âŒ æœ‰é©—è­‰å¤±æ•—"
              exit 1
          fi