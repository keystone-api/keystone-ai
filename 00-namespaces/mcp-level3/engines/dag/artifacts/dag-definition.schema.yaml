# DAG Definition Artifact Schema
# Defines the structure for workflow DAG definitions in MCP Level 3

version: "1.0.0"
semantic_role: "dag_definition"
artifact_type: "schema"
semantic_root: true

metadata:
  name: "dag-definition"
  description: "Schema for directed acyclic graph workflow definitions"
  author: "MCP Core Team"
  created: "2025-01-11"
  updated: "2025-01-11"
  tags:
    - "dag"
    - "workflow"
    - "orchestration"
    - "pipeline"

schema:
  type: "object"
  required:
    - "dag_id"
    - "name"
    - "version"
    - "nodes"
    - "edges"
    - "metadata"
  properties:
    dag_id:
      type: "string"
      description: "Unique identifier for the DAG"
      pattern: "^dag:[a-zA-Z0-9_-]+:[0-9]+$"
      example: "dag:ml_pipeline:001"
      
    name:
      type: "string"
      description: "Human-readable name of the DAG"
      minLength: 1
      maxLength: 255
      example: "Machine Learning Training Pipeline"
      
    version:
      type: "string"
      description: "Semantic version of the DAG"
      pattern: "^[0-9]+\\.[0-9]+\\.[0-9]+$"
      example: "1.2.0"
      
    description:
      type: "string"
      description: "Detailed description of the DAG purpose"
      example: "End-to-end ML pipeline for model training and deployment"
      
    nodes:
      type: "array"
      description: "List of nodes in the DAG"
      minItems: 1
      items:
        type: "object"
        required:
          - "node_id"
          - "node_type"
          - "task"
        properties:
          node_id:
            type: "string"
            description: "Unique identifier for the node"
            pattern: "^node:[a-zA-Z0-9_-]+$"
            example: "node:data_ingestion"
            
          node_type:
            type: "string"
            description: "Type of node"
            enum: ["task", "decision", "parallel", "subdag", "trigger"]
            example: "task"
            
          task:
            type: "object"
            description: "Task definition"
            required:
              - "task_id"
              - "task_type"
            properties:
              task_id:
                type: "string"
                example: "task:ingest_data"
                
              task_type:
                type: "string"
                description: "Type of task to execute"
                enum: ["python", "bash", "docker", "kubernetes", "http", "mcp_tool"]
                example: "python"
                
              executor:
                type: "string"
                description: "Executor for the task"
                example: "python_operator"
                
              config:
                type: "object"
                description: "Task-specific configuration"
                additionalProperties: true
                example:
                  script: "scripts/ingest.py"
                  args: ["--source", "s3://data"]
                  
              retry_policy:
                type: "object"
                properties:
                  max_retries:
                    type: "integer"
                    minimum: 0
                    default: 3
                    example: 3
                  retry_delay_seconds:
                    type: "integer"
                    minimum: 0
                    default: 60
                    example: 60
                  exponential_backoff:
                    type: "boolean"
                    default: true
                    example: true
                    
              timeout_seconds:
                type: "integer"
                description: "Task timeout in seconds"
                minimum: 1
                example: 3600
                
          dependencies:
            type: "array"
            description: "List of upstream node IDs"
            items:
              type: "string"
            example: ["node:data_validation"]
            
          condition:
            type: "object"
            description: "Conditional execution rules"
            properties:
              expression:
                type: "string"
                description: "Boolean expression for execution"
                example: "{{ upstream.data_validation.status == 'success' }}"
              on_true:
                type: "string"
                description: "Action if condition is true"
                enum: ["execute", "skip"]
                default: "execute"
              on_false:
                type: "string"
                description: "Action if condition is false"
                enum: ["execute", "skip", "fail"]
                default: "skip"
                
          resources:
            type: "object"
            description: "Resource requirements"
            properties:
              cpu:
                type: "string"
                example: "2"
              memory:
                type: "string"
                example: "4Gi"
              gpu:
                type: "integer"
                minimum: 0
                example: 1
                
          labels:
            type: "object"
            description: "Node labels for categorization"
            additionalProperties:
              type: "string"
            example:
              stage: "preprocessing"
              criticality: "high"
              
    edges:
      type: "array"
      description: "List of edges connecting nodes"
      items:
        type: "object"
        required:
          - "edge_id"
          - "source"
          - "target"
        properties:
          edge_id:
            type: "string"
            description: "Unique identifier for the edge"
            pattern: "^edge:[a-zA-Z0-9_-]+$"
            example: "edge:ingest_to_validate"
            
          source:
            type: "string"
            description: "Source node ID"
            example: "node:data_ingestion"
            
          target:
            type: "string"
            description: "Target node ID"
            example: "node:data_validation"
            
          edge_type:
            type: "string"
            description: "Type of edge"
            enum: ["data", "control", "trigger"]
            default: "control"
            example: "data"
            
          condition:
            type: "string"
            description: "Condition for edge traversal"
            example: "{{ source.output.valid == true }}"
            
          data_transfer:
            type: "object"
            description: "Data transfer specification"
            properties:
              artifacts:
                type: "array"
                items:
                  type: "string"
                example: ["processed_data.csv"]
              format:
                type: "string"
                example: "parquet"
                
    metadata:
      type: "object"
      required:
        - "created_at"
        - "created_by"
      properties:
        created_at:
          type: "string"
          format: "date-time"
          description: "DAG creation timestamp"
          example: "2025-01-11T10:00:00Z"
          
        created_by:
          type: "string"
          description: "Creator of the DAG"
          example: "user:data_engineer"
          
        updated_at:
          type: "string"
          format: "date-time"
          description: "Last update timestamp"
          example: "2025-01-11T12:00:00Z"
          
        updated_by:
          type: "string"
          description: "Last updater"
          example: "user:ml_engineer"
          
        tags:
          type: "array"
          description: "Tags for categorization"
          items:
            type: "string"
          example: ["ml", "production", "daily"]
          
        owner:
          type: "string"
          description: "Owner of the DAG"
          example: "team:ml_platform"
          
        schedule:
          type: "object"
          description: "Scheduling configuration"
          properties:
            cron:
              type: "string"
              description: "Cron expression for scheduling"
              example: "0 2 * * *"
            timezone:
              type: "string"
              description: "Timezone for schedule"
              example: "UTC"
            enabled:
              type: "boolean"
              default: true
              example: true
              
    validation:
      type: "object"
      description: "DAG validation results"
      properties:
        is_valid:
          type: "boolean"
          description: "Whether DAG is valid"
          example: true
          
        is_acyclic:
          type: "boolean"
          description: "Whether DAG has no cycles"
          example: true
          
        validation_errors:
          type: "array"
          description: "List of validation errors"
          items:
            type: "object"
            properties:
              error_type:
                type: "string"
              message:
                type: "string"
              node_id:
                type: "string"
          example: []
          
        validation_timestamp:
          type: "string"
          format: "date-time"
          example: "2025-01-11T10:05:00Z"
          
    execution_config:
      type: "object"
      description: "Execution configuration"
      properties:
        max_active_runs:
          type: "integer"
          description: "Maximum concurrent runs"
          minimum: 1
          default: 1
          example: 3
          
        concurrency:
          type: "integer"
          description: "Maximum concurrent tasks"
          minimum: 1
          default: 16
          example: 32
          
        default_timeout_seconds:
          type: "integer"
          description: "Default task timeout"
          minimum: 1
          default: 3600
          example: 7200
          
        on_failure:
          type: "string"
          description: "Action on DAG failure"
          enum: ["fail", "retry", "skip"]
          default: "fail"
          example: "retry"
          
        notification:
          type: "object"
          properties:
            on_success:
              type: "array"
              items:
                type: "string"
              example: ["email:team@example.com"]
            on_failure:
              type: "array"
              items:
                type: "string"
              example: ["slack:ml-alerts", "email:oncall@example.com"]

validation_rules:
  - rule: "dag_id_format"
    description: "DAG ID must follow naming convention"
    expression: "dag_id matches pattern 'dag:name:version'"
    
  - rule: "no_cycles"
    description: "DAG must be acyclic"
    expression: "validation.is_acyclic == true"
    
  - rule: "valid_node_references"
    description: "All edge source/target must reference existing nodes"
    expression: "all edges reference valid node_ids"
    
  - rule: "unique_node_ids"
    description: "All node IDs must be unique"
    expression: "node_ids are unique"

examples:
  - name: "simple_ml_pipeline"
    description: "Simple ML training pipeline"
    data:
      dag_id: "dag:ml_pipeline:001"
      name: "ML Training Pipeline"
      version: "1.0.0"
      description: "Simple pipeline for model training"
      nodes:
        - node_id: "node:data_ingestion"
          node_type: "task"
          task:
            task_id: "task:ingest_data"
            task_type: "python"
            executor: "python_operator"
            config:
              script: "scripts/ingest.py"
            retry_policy:
              max_retries: 3
              retry_delay_seconds: 60
          dependencies: []
        - node_id: "node:data_validation"
          node_type: "task"
          task:
            task_id: "task:validate_data"
            task_type: "python"
            executor: "python_operator"
            config:
              script: "scripts/validate.py"
          dependencies: ["node:data_ingestion"]
        - node_id: "node:model_training"
          node_type: "task"
          task:
            task_id: "task:train_model"
            task_type: "python"
            executor: "python_operator"
            config:
              script: "scripts/train.py"
            timeout_seconds: 7200
          dependencies: ["node:data_validation"]
          resources:
            cpu: "4"
            memory: "16Gi"
            gpu: 1
      edges:
        - edge_id: "edge:ingest_to_validate"
          source: "node:data_ingestion"
          target: "node:data_validation"
          edge_type: "data"
        - edge_id: "edge:validate_to_train"
          source: "node:data_validation"
          target: "node:model_training"
          edge_type: "data"
      metadata:
        created_at: "2025-01-11T10:00:00Z"
        created_by: "user:ml_engineer"
        tags: ["ml", "training"]
        owner: "team:ml_platform"
        schedule:
          cron: "0 2 * * *"
          timezone: "UTC"
          enabled: true
      validation:
        is_valid: true
        is_acyclic: true
        validation_errors: []
        validation_timestamp: "2025-01-11T10:05:00Z"
      execution_config:
        max_active_runs: 1
        concurrency: 16
        default_timeout_seconds: 3600

usage_guidelines:
  - "Validate DAG structure before deployment"
  - "Use meaningful node and edge IDs"
  - "Set appropriate retry policies for each task"
  - "Define resource requirements for resource-intensive tasks"
  - "Use labels for task categorization and monitoring"
  - "Configure notifications for critical workflows"

performance_considerations:
  - "Optimize DAG structure to minimize dependencies"
  - "Use parallel execution where possible"
  - "Set appropriate concurrency limits"
  - "Monitor and tune timeout values"
  - "Consider task granularity for better parallelism"