# MCP Level 3 - Execution Engine: Rollback Manifest Schema
# Purpose: Define rollback procedures and state restoration for failed executions
# Version: 1.0.0
# Last Updated: 2025-01-11

schema:
  name: rollback-manifest
  version: "1.0.0"
  namespace: mcp.level3.execution.artifacts
  description: |
    Rollback manifest artifact for defining procedures to restore system state after failed executions.
    Supports multi-step rollback, state snapshots, and automated recovery.
    Ensures system consistency and data integrity during failure scenarios.

  type: object
  required:
    - manifest_id
    - execution_id
    - rollback_strategy
    - steps
    - created_at
  
  properties:
    # Core Identity
    manifest_id:
      type: string
      format: uuid
      description: Unique identifier for the rollback manifest
      example: "550e8400-e29b-41d4-a716-446655440000"
      index: true
    
    execution_id:
      type: string
      format: uuid
      description: ID of the execution this rollback is for
      example: "660e8400-e29b-41d4-a716-446655440001"
      index: true
    
    name:
      type: string
      description: Human-readable name for the rollback
      example: "Rollback ML Pipeline Deployment v2.1"
      minLength: 3
      maxLength: 200
      optional: true
    
    description:
      type: string
      description: Detailed description of the rollback procedure
      example: "Rollback deployment of ML pipeline v2.1 to previous stable version v2.0"
      maxLength: 2000
      optional: true
    
    # Rollback Strategy
    rollback_strategy:
      type: object
      description: Strategy for performing the rollback
      required:
        - type
        - mode
      properties:
        type:
          type: string
          enum:
            - full
            - partial
            - incremental
            - selective
            - cascading
          description: Type of rollback
          example: "full"
        
        mode:
          type: string
          enum:
            - automatic
            - manual
            - semi_automatic
            - on_demand
          description: Rollback execution mode
          example: "automatic"
        
        scope:
          type: string
          enum:
            - local
            - distributed
            - global
          description: Scope of the rollback
          example: "distributed"
          default: "local"
        
        timeout:
          type: integer
          description: Maximum time for rollback in seconds
          example: 300
          minimum: 1
          default: 300
        
        retry_policy:
          type: object
          description: Retry policy for failed rollback steps
          properties:
            max_retries:
              type: integer
              minimum: 0
              description: Maximum number of retries
              example: 3
              default: 3
            
            retry_delay:
              type: integer
              minimum: 0
              description: Delay between retries in seconds
              example: 5
              default: 5
            
            backoff_multiplier:
              type: number
              minimum: 1.0
              description: Exponential backoff multiplier
              example: 2.0
              default: 2.0
            
            max_delay:
              type: integer
              minimum: 0
              description: Maximum retry delay in seconds
              example: 60
              default: 60
        
        failure_handling:
          type: string
          enum:
            - stop_on_error
            - continue_on_error
            - rollback_on_error
            - skip_on_error
          description: How to handle step failures
          example: "stop_on_error"
          default: "stop_on_error"
    
    # Rollback Steps
    steps:
      type: array
      description: Ordered list of rollback steps
      items:
        type: object
        required:
          - step_id
          - name
          - action
          - order
        properties:
          step_id:
            type: string
            format: uuid
            description: Unique step identifier
            example: "770e8400-e29b-41d4-a716-446655440002"
          
          name:
            type: string
            description: Step name
            example: "Restore Database State"
            minLength: 1
            maxLength: 200
          
          description:
            type: string
            description: Step description
            example: "Restore database to snapshot taken before deployment"
            maxLength: 1000
            optional: true
          
          action:
            type: object
            description: Action to perform
            required:
              - type
            properties:
              type:
                type: string
                enum:
                  - restore_snapshot
                  - revert_config
                  - delete_resource
                  - update_resource
                  - execute_script
                  - call_api
                  - run_command
                  - restore_backup
                  - switch_version
                description: Action type
                example: "restore_snapshot"
              
              target:
                type: string
                description: Target resource or component
                example: "database:production"
              
              parameters:
                type: object
                description: Action parameters
                additionalProperties: true
                example:
                  snapshot_id: "snap-20250111-100000"
                  verify_integrity: true
              
              command:
                type: string
                description: Command to execute (for execute_script/run_command)
                example: "kubectl rollout undo deployment/ml-pipeline"
                optional: true
              
              script:
                type: string
                description: Script content (for execute_script)
                optional: true
              
              api_endpoint:
                type: string
                format: uri
                description: API endpoint (for call_api)
                optional: true
              
              api_method:
                type: string
                enum:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - PATCH
                description: HTTP method (for call_api)
                optional: true
              
              api_payload:
                type: object
                description: API request payload
                additionalProperties: true
                optional: true
          
          order:
            type: integer
            minimum: 1
            description: Execution order (lower numbers execute first)
            example: 1
          
          dependencies:
            type: array
            description: Step IDs this step depends on
            items:
              type: string
              format: uuid
            example:
              - "880e8400-e29b-41d4-a716-446655440003"
            optional: true
          
          condition:
            type: object
            description: Condition for executing this step
            optional: true
            properties:
              type:
                type: string
                enum:
                  - always
                  - on_failure
                  - on_success
                  - conditional
                description: Condition type
                example: "always"
              
              expression:
                type: string
                description: Conditional expression
                example: "previous_step.status == 'failed'"
                optional: true
          
          timeout:
            type: integer
            minimum: 1
            description: Step timeout in seconds
            example: 60
            optional: true
          
          critical:
            type: boolean
            description: Whether step failure should abort rollback
            example: true
            default: false
          
          validation:
            type: object
            description: Validation to perform after step
            optional: true
            properties:
              type:
                type: string
                enum:
                  - health_check
                  - data_integrity
                  - state_verification
                  - custom
                description: Validation type
              
              checks:
                type: array
                description: Validation checks
                items:
                  type: object
                  properties:
                    name:
                      type: string
                      description: Check name
                    condition:
                      type: string
                      description: Validation condition
                    error_message:
                      type: string
                      description: Error message if check fails
      minItems: 1
    
    # State Snapshots
    snapshots:
      type: array
      description: State snapshots for restoration
      items:
        type: object
        required:
          - snapshot_id
          - type
          - created_at
        properties:
          snapshot_id:
            type: string
            format: uuid
            description: Snapshot identifier
            example: "990e8400-e29b-41d4-a716-446655440004"
          
          type:
            type: string
            enum:
              - full
              - incremental
              - differential
            description: Snapshot type
            example: "full"
          
          target:
            type: string
            description: Target resource
            example: "database:production"
          
          location:
            type: string
            description: Snapshot storage location
            example: "s3://backups/snapshots/snap-20250111-100000"
          
          size:
            type: integer
            minimum: 0
            description: Snapshot size in bytes
            example: 1073741824
          
          checksum:
            type: string
            description: Snapshot checksum for integrity verification
            example: "sha256:a1b2c3d4e5f6..."
          
          created_at:
            type: string
            format: date-time
            description: Snapshot creation timestamp
            example: "2025-01-11T09:55:00Z"
          
          expires_at:
            type: string
            format: date-time
            description: Snapshot expiration timestamp
            example: "2025-01-18T09:55:00Z"
            optional: true
          
          metadata:
            type: object
            description: Additional snapshot metadata
            additionalProperties: true
            optional: true
      optional: true
    
    # Affected Resources
    affected_resources:
      type: array
      description: Resources affected by the rollback
      items:
        type: object
        properties:
          resource_id:
            type: string
            description: Resource identifier
            example: "deployment:ml-pipeline"
          
          resource_type:
            type: string
            description: Resource type
            example: "kubernetes_deployment"
          
          current_state:
            type: string
            description: Current resource state
            example: "v2.1.0"
          
          target_state:
            type: string
            description: Target state after rollback
            example: "v2.0.0"
          
          impact:
            type: string
            enum:
              - high
              - medium
              - low
            description: Impact level
            example: "high"
      optional: true
    
    # Execution Status
    status:
      type: string
      enum:
        - pending
        - in_progress
        - completed
        - failed
        - cancelled
        - partial
      description: Rollback execution status
      example: "pending"
      default: "pending"
    
    execution_log:
      type: array
      description: Log of rollback execution
      items:
        type: object
        properties:
          timestamp:
            type: string
            format: date-time
            description: Log entry timestamp
          
          step_id:
            type: string
            format: uuid
            description: Step ID
            optional: true
          
          level:
            type: string
            enum:
              - debug
              - info
              - warning
              - error
            description: Log level
          
          message:
            type: string
            description: Log message
          
          details:
            type: object
            description: Additional details
            additionalProperties: true
            optional: true
      optional: true
    
    # Timing
    created_at:
      type: string
      format: date-time
      description: Manifest creation timestamp
      example: "2025-01-11T10:00:00Z"
      index: true
    
    started_at:
      type: string
      format: date-time
      description: Rollback start timestamp
      example: "2025-01-11T10:05:00Z"
      optional: true
    
    completed_at:
      type: string
      format: date-time
      description: Rollback completion timestamp
      example: "2025-01-11T10:10:00Z"
      optional: true
    
    duration:
      type: integer
      minimum: 0
      description: Rollback duration in seconds
      example: 300
      optional: true
    
    # Metadata
    metadata:
      type: object
      description: Additional metadata
      optional: true
      properties:
        triggered_by:
          type: string
          description: Who/what triggered the rollback
          example: "system:auto-recovery"
        
        trigger_reason:
          type: string
          description: Reason for rollback
          example: "Deployment health check failed"
        
        approval_required:
          type: boolean
          description: Whether approval is required
          default: false
        
        approved_by:
          type: string
          description: Who approved the rollback
          optional: true
        
        approved_at:
          type: string
          format: date-time
          description: Approval timestamp
          optional: true
        
        tags:
          type: array
          items:
            type: string
          description: Classification tags
          example:
            - "automatic"
            - "critical"
        
        custom:
          type: object
          description: Custom metadata
          additionalProperties: true

  # Validation Rules
  validation:
    rules:
      - name: valid_execution_reference
        condition: execution_id exists
        message: "Must reference a valid execution"
        severity: error
      
      - name: steps_not_empty
        condition: len(steps) > 0
        message: "Must have at least one rollback step"
        severity: error
      
      - name: valid_step_order
        condition: all_steps_have_unique_order()
        message: "Step order numbers must be unique"
        severity: error
      
      - name: valid_dependencies
        condition: all_dependencies_exist()
        message: "All step dependencies must reference existing steps"
        severity: error
      
      - name: no_circular_dependencies
        condition: no_circular_step_dependencies()
        message: "Step dependencies must not form cycles"
        severity: error
      
      - name: timing_consistency
        condition: started_at == null || completed_at == null || started_at < completed_at
        message: "started_at must be before completed_at"
        severity: error

  # Indexes
  indexes:
    - fields: [manifest_id]
      unique: true
    - fields: [execution_id]
    - fields: [status, created_at]
    - fields: [created_at]

# Usage Examples
examples:
  - name: ml_pipeline_rollback
    description: Rollback failed ML pipeline deployment
    data:
      manifest_id: "550e8400-e29b-41d4-a716-446655440000"
      execution_id: "660e8400-e29b-41d4-a716-446655440001"
      name: "Rollback ML Pipeline Deployment v2.1"
      description: "Rollback deployment of ML pipeline v2.1 to previous stable version v2.0"
      rollback_strategy:
        type: "full"
        mode: "automatic"
        scope: "distributed"
        timeout: 300
        retry_policy:
          max_retries: 3
          retry_delay: 5
          backoff_multiplier: 2.0
          max_delay: 60
        failure_handling: "stop_on_error"
      steps:
        - step_id: "770e8400-e29b-41d4-a716-446655440002"
          name: "Stop New Deployment"
          description: "Stop the failed v2.1 deployment"
          action:
            type: "run_command"
            target: "kubernetes:production"
            command: "kubectl scale deployment/ml-pipeline-v2.1 --replicas=0"
          order: 1
          timeout: 30
          critical: true
        - step_id: "770e8400-e29b-41d4-a716-446655440003"
          name: "Restore Previous Version"
          description: "Scale up previous stable version v2.0"
          action:
            type: "run_command"
            target: "kubernetes:production"
            command: "kubectl scale deployment/ml-pipeline-v2.0 --replicas=3"
          order: 2
          dependencies:
            - "770e8400-e29b-41d4-a716-446655440002"
          timeout: 60
          critical: true
          validation:
            type: "health_check"
            checks:
              - name: "pods_ready"
                condition: "ready_pods >= 3"
                error_message: "Not all pods are ready"
        - step_id: "770e8400-e29b-41d4-a716-446655440004"
          name: "Restore Database State"
          description: "Restore database to pre-deployment snapshot"
          action:
            type: "restore_snapshot"
            target: "database:production"
            parameters:
              snapshot_id: "snap-20250111-095500"
              verify_integrity: true
          order: 3
          dependencies:
            - "770e8400-e29b-41d4-a716-446655440003"
          timeout: 120
          critical: true
        - step_id: "770e8400-e29b-41d4-a716-446655440005"
          name: "Update Load Balancer"
          description: "Route traffic to v2.0"
          action:
            type: "call_api"
            api_endpoint: "https://api.loadbalancer.example.com/routes"
            api_method: "PUT"
            api_payload:
              service: "ml-pipeline"
              target_version: "v2.0"
          order: 4
          dependencies:
            - "770e8400-e29b-41d4-a716-446655440003"
          timeout: 30
          critical: false
      snapshots:
        - snapshot_id: "snap-20250111-095500"
          type: "full"
          target: "database:production"
          location: "s3://backups/snapshots/snap-20250111-095500"
          size: 1073741824
          checksum: "sha256:a1b2c3d4e5f6..."
          created_at: "2025-01-11T09:55:00Z"
          expires_at: "2025-01-18T09:55:00Z"
      affected_resources:
        - resource_id: "deployment:ml-pipeline-v2.1"
          resource_type: "kubernetes_deployment"
          current_state: "running"
          target_state: "stopped"
          impact: "high"
        - resource_id: "deployment:ml-pipeline-v2.0"
          resource_type: "kubernetes_deployment"
          current_state: "stopped"
          target_state: "running"
          impact: "high"
        - resource_id: "database:production"
          resource_type: "postgresql_database"
          current_state: "v2.1-schema"
          target_state: "v2.0-schema"
          impact: "high"
      status: "pending"
      created_at: "2025-01-11T10:00:00Z"
      metadata:
        triggered_by: "system:auto-recovery"
        trigger_reason: "Deployment health check failed - error rate > 5%"
        approval_required: false
        tags:
          - "automatic"
          - "critical"
          - "production"

# Integration Guidelines
integration:
  creation:
    - Create manifest before risky operations
    - Capture state snapshots
    - Define clear rollback steps
    - Test rollback procedures
    - Document dependencies
  
  execution:
    - Validate manifest before execution
    - Execute steps in order
    - Handle failures gracefully
    - Log all actions
    - Verify final state
  
  monitoring:
    - Track rollback progress
    - Alert on failures
    - Measure rollback time
    - Verify system health
    - Document outcomes

# Performance Considerations
performance:
  snapshots:
    - Use incremental snapshots when possible
    - Compress snapshot data
    - Store snapshots efficiently
    - Implement snapshot retention policies
  
  execution:
    - Parallelize independent steps
    - Use connection pooling
    - Implement efficient state checks
    - Cache validation results
  
  recovery:
    - Minimize downtime
    - Prioritize critical steps
    - Use fast rollback strategies
    - Implement circuit breakers