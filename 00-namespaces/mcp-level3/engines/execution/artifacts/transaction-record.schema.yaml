# MCP Level 3 - Execution Engine: Transaction Record Schema
# Purpose: Define atomic transaction records for tracking state changes and ensuring ACID properties
# Version: 1.0.0
# Last Updated: 2025-01-11

schema:
  name: transaction-record
  version: "1.0.0"
  namespace: mcp.level3.execution.artifacts
  description: |
    Transaction record artifact for tracking atomic operations and state changes.
    Supports ACID properties (Atomicity, Consistency, Isolation, Durability).
    Enables distributed transactions, two-phase commit, and saga patterns.

  type: object
  required:
    - transaction_id
    - type
    - status
    - operations
    - created_at
  
  properties:
    # Core Identity
    transaction_id:
      type: string
      format: uuid
      description: Unique transaction identifier
      example: "550e8400-e29b-41d4-a716-446655440000"
      index: true
    
    parent_transaction_id:
      type: string
      format: uuid
      description: Parent transaction ID for nested transactions
      example: "660e8400-e29b-41d4-a716-446655440001"
      optional: true
      index: true
    
    execution_id:
      type: string
      format: uuid
      description: Associated execution ID
      example: "770e8400-e29b-41d4-a716-446655440002"
      optional: true
      index: true
    
    name:
      type: string
      description: Human-readable transaction name
      example: "Deploy ML Model v2.1"
      minLength: 1
      maxLength: 200
      optional: true
    
    description:
      type: string
      description: Detailed transaction description
      example: "Atomic deployment of ML model v2.1 with database migration"
      maxLength: 2000
      optional: true
    
    # Transaction Type
    type:
      type: string
      enum:
        - local
        - distributed
        - nested
        - compensating
        - saga
        - two_phase_commit
      description: Transaction type
      example: "distributed"
    
    pattern:
      type: string
      enum:
        - acid
        - saga
        - tcc
        - eventual_consistency
      description: Transaction pattern
      example: "saga"
      optional: true
    
    # Transaction Status
    status:
      type: string
      enum:
        - pending
        - preparing
        - prepared
        - committing
        - committed
        - aborting
        - aborted
        - failed
        - compensating
        - compensated
      description: Current transaction status
      example: "committed"
      index: true
    
    # Operations
    operations:
      type: array
      description: List of operations in this transaction
      items:
        type: object
        required:
          - operation_id
          - type
          - status
        properties:
          operation_id:
            type: string
            format: uuid
            description: Unique operation identifier
            example: "880e8400-e29b-41d4-a716-446655440003"
          
          type:
            type: string
            enum:
              - create
              - read
              - update
              - delete
              - execute
              - deploy
              - rollback
              - compensate
            description: Operation type
            example: "update"
          
          resource:
            type: object
            description: Target resource
            required:
              - id
              - type
            properties:
              id:
                type: string
                description: Resource identifier
                example: "model:ml-pipeline-v2.1"
              
              type:
                type: string
                description: Resource type
                example: "ml_model"
              
              namespace:
                type: string
                description: Resource namespace
                example: "production"
                optional: true
          
          action:
            type: object
            description: Action to perform
            required:
              - method
            properties:
              method:
                type: string
                description: Action method
                example: "deploy"
              
              parameters:
                type: object
                description: Action parameters
                additionalProperties: true
                example:
                  version: "2.1.0"
                  replicas: 3
              
              command:
                type: string
                description: Command to execute
                optional: true
              
              script:
                type: string
                description: Script content
                optional: true
          
          status:
            type: string
            enum:
              - pending
              - executing
              - completed
              - failed
              - compensating
              - compensated
              - skipped
            description: Operation status
            example: "completed"
          
          order:
            type: integer
            minimum: 1
            description: Execution order
            example: 1
          
          dependencies:
            type: array
            description: Operation dependencies
            items:
              type: string
              format: uuid
            optional: true
          
          # State Changes
          state_before:
            type: object
            description: Resource state before operation
            additionalProperties: true
            optional: true
            example:
              version: "2.0.0"
              status: "running"
          
          state_after:
            type: object
            description: Resource state after operation
            additionalProperties: true
            optional: true
            example:
              version: "2.1.0"
              status: "running"
          
          # Compensation
          compensation:
            type: object
            description: Compensation action for rollback
            optional: true
            properties:
              method:
                type: string
                description: Compensation method
                example: "rollback_deployment"
              
              parameters:
                type: object
                description: Compensation parameters
                additionalProperties: true
              
              automatic:
                type: boolean
                description: Whether compensation is automatic
                default: true
          
          # Timing
          started_at:
            type: string
            format: date-time
            description: Operation start time
            optional: true
          
          completed_at:
            type: string
            format: date-time
            description: Operation completion time
            optional: true
          
          duration:
            type: integer
            minimum: 0
            description: Operation duration in milliseconds
            optional: true
          
          # Result
          result:
            type: object
            description: Operation result
            optional: true
            properties:
              success:
                type: boolean
                description: Whether operation succeeded
              
              output:
                description: Operation output
                optional: true
              
              error:
                type: object
                description: Error information if failed
                optional: true
                properties:
                  code:
                    type: string
                    description: Error code
                  message:
                    type: string
                    description: Error message
                  details:
                    type: object
                    description: Error details
                    additionalProperties: true
      minItems: 1
    
    # Isolation Level
    isolation_level:
      type: string
      enum:
        - read_uncommitted
        - read_committed
        - repeatable_read
        - serializable
        - snapshot
      description: Transaction isolation level
      example: "read_committed"
      default: "read_committed"
    
    # Locking
    locks:
      type: array
      description: Resources locked by this transaction
      items:
        type: object
        properties:
          resource_id:
            type: string
            description: Locked resource ID
          
          lock_type:
            type: string
            enum:
              - shared
              - exclusive
              - intent_shared
              - intent_exclusive
            description: Lock type
          
          acquired_at:
            type: string
            format: date-time
            description: Lock acquisition time
          
          released_at:
            type: string
            format: date-time
            description: Lock release time
            optional: true
      optional: true
    
    # Participants (for distributed transactions)
    participants:
      type: array
      description: Participants in distributed transaction
      items:
        type: object
        properties:
          participant_id:
            type: string
            description: Participant identifier
            example: "service:database-primary"
          
          role:
            type: string
            enum:
              - coordinator
              - participant
              - resource_manager
            description: Participant role
          
          status:
            type: string
            enum:
              - ready
              - prepared
              - committed
              - aborted
              - failed
            description: Participant status
          
          vote:
            type: string
            enum:
              - commit
              - abort
              - unknown
            description: Participant vote (2PC)
            optional: true
          
          endpoint:
            type: string
            format: uri
            description: Participant endpoint
            optional: true
      optional: true
    
    # Saga Pattern (for long-running transactions)
    saga:
      type: object
      description: Saga pattern configuration
      optional: true
      properties:
        saga_id:
          type: string
          format: uuid
          description: Saga identifier
        
        steps:
          type: array
          description: Saga steps
          items:
            type: object
            properties:
              step_id:
                type: string
                format: uuid
                description: Step identifier
              
              operation_id:
                type: string
                format: uuid
                description: Associated operation ID
              
              compensation_id:
                type: string
                format: uuid
                description: Compensation operation ID
                optional: true
              
              status:
                type: string
                enum:
                  - pending
                  - executing
                  - completed
                  - compensating
                  - compensated
                  - failed
                description: Step status
        
        compensation_strategy:
          type: string
          enum:
            - backward
            - forward
            - mixed
          description: Compensation strategy
          default: "backward"
    
    # Timing
    created_at:
      type: string
      format: date-time
      description: Transaction creation time
      example: "2025-01-11T10:00:00Z"
      index: true
    
    started_at:
      type: string
      format: date-time
      description: Transaction start time
      example: "2025-01-11T10:00:05Z"
      optional: true
    
    committed_at:
      type: string
      format: date-time
      description: Transaction commit time
      example: "2025-01-11T10:05:00Z"
      optional: true
    
    aborted_at:
      type: string
      format: date-time
      description: Transaction abort time
      optional: true
    
    duration:
      type: integer
      minimum: 0
      description: Transaction duration in milliseconds
      example: 295000
      optional: true
    
    timeout:
      type: integer
      minimum: 1
      description: Transaction timeout in seconds
      example: 300
      default: 300
    
    # Idempotency
    idempotency_key:
      type: string
      description: Idempotency key for duplicate detection
      example: "deploy-ml-model-v2.1-20250111"
      optional: true
      index: true
    
    # Audit Trail
    audit_trail:
      type: array
      description: Audit trail of transaction events
      items:
        type: object
        properties:
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
          
          event:
            type: string
            description: Event type
            example: "transaction_started"
          
          actor:
            type: string
            description: Who/what triggered the event
            example: "user:admin@example.com"
          
          details:
            type: object
            description: Event details
            additionalProperties: true
      optional: true
    
    # Metadata
    metadata:
      type: object
      description: Additional metadata
      optional: true
      properties:
        initiated_by:
          type: string
          description: Who initiated the transaction
          example: "user:admin@example.com"
        
        source:
          type: string
          description: Transaction source
          example: "api:deployment-service"
        
        priority:
          type: integer
          minimum: 1
          maximum: 10
          description: Transaction priority
          example: 5
          default: 5
        
        tags:
          type: array
          items:
            type: string
          description: Classification tags
          example:
            - "deployment"
            - "production"
            - "critical"
        
        context:
          type: object
          description: Execution context
          additionalProperties: true
        
        custom:
          type: object
          description: Custom metadata
          additionalProperties: true

  # Validation Rules
  validation:
    rules:
      - name: operations_not_empty
        condition: len(operations) > 0
        message: "Transaction must have at least one operation"
        severity: error
      
      - name: valid_status_transitions
        condition: is_valid_status_transition()
        message: "Invalid status transition"
        severity: error
      
      - name: timing_consistency
        condition: started_at == null || committed_at == null || started_at < committed_at
        message: "started_at must be before committed_at"
        severity: error
      
      - name: valid_operation_dependencies
        condition: all_operation_dependencies_exist()
        message: "All operation dependencies must reference existing operations"
        severity: error
      
      - name: no_circular_dependencies
        condition: no_circular_operation_dependencies()
        message: "Operation dependencies must not form cycles"
        severity: error
      
      - name: distributed_has_participants
        condition: type != 'distributed' || len(participants) > 0
        message: "Distributed transactions must have participants"
        severity: error

  # Indexes
  indexes:
    - fields: [transaction_id]
      unique: true
    - fields: [parent_transaction_id]
    - fields: [execution_id]
    - fields: [status, created_at]
    - fields: [idempotency_key]
    - fields: [created_at]

# Usage Examples
examples:
  - name: distributed_deployment_transaction
    description: Distributed transaction for ML model deployment
    data:
      transaction_id: "550e8400-e29b-41d4-a716-446655440000"
      execution_id: "770e8400-e29b-41d4-a716-446655440002"
      name: "Deploy ML Model v2.1"
      description: "Atomic deployment of ML model v2.1 with database migration"
      type: "distributed"
      pattern: "two_phase_commit"
      status: "committed"
      operations:
        - operation_id: "880e8400-e29b-41d4-a716-446655440003"
          type: "update"
          resource:
            id: "database:production"
            type: "postgresql_database"
            namespace: "production"
          action:
            method: "migrate_schema"
            parameters:
              from_version: "2.0.0"
              to_version: "2.1.0"
          status: "completed"
          order: 1
          state_before:
            schema_version: "2.0.0"
          state_after:
            schema_version: "2.1.0"
          compensation:
            method: "rollback_migration"
            parameters:
              to_version: "2.0.0"
            automatic: true
          started_at: "2025-01-11T10:00:05Z"
          completed_at: "2025-01-11T10:02:00Z"
          duration: 115000
          result:
            success: true
            output:
              migrations_applied: 5
        - operation_id: "880e8400-e29b-41d4-a716-446655440004"
          type: "deploy"
          resource:
            id: "model:ml-pipeline-v2.1"
            type: "ml_model"
            namespace: "production"
          action:
            method: "deploy"
            parameters:
              version: "2.1.0"
              replicas: 3
          status: "completed"
          order: 2
          dependencies:
            - "880e8400-e29b-41d4-a716-446655440003"
          state_before:
            version: "2.0.0"
            replicas: 3
            status: "running"
          state_after:
            version: "2.1.0"
            replicas: 3
            status: "running"
          compensation:
            method: "rollback_deployment"
            parameters:
              to_version: "2.0.0"
            automatic: true
          started_at: "2025-01-11T10:02:05Z"
          completed_at: "2025-01-11T10:04:30Z"
          duration: 145000
          result:
            success: true
            output:
              pods_deployed: 3
              health_check: "passed"
      isolation_level: "read_committed"
      participants:
        - participant_id: "service:database-primary"
          role: "participant"
          status: "committed"
          vote: "commit"
        - participant_id: "service:kubernetes-cluster"
          role: "participant"
          status: "committed"
          vote: "commit"
        - participant_id: "service:transaction-coordinator"
          role: "coordinator"
          status: "committed"
      created_at: "2025-01-11T10:00:00Z"
      started_at: "2025-01-11T10:00:05Z"
      committed_at: "2025-01-11T10:05:00Z"
      duration: 295000
      timeout: 300
      idempotency_key: "deploy-ml-model-v2.1-20250111"
      audit_trail:
        - timestamp: "2025-01-11T10:00:00Z"
          event: "transaction_created"
          actor: "user:admin@example.com"
          details:
            source: "api:deployment-service"
        - timestamp: "2025-01-11T10:00:05Z"
          event: "transaction_started"
          actor: "system:transaction-coordinator"
        - timestamp: "2025-01-11T10:04:35Z"
          event: "prepare_phase_completed"
          actor: "system:transaction-coordinator"
          details:
            all_participants_ready: true
        - timestamp: "2025-01-11T10:05:00Z"
          event: "transaction_committed"
          actor: "system:transaction-coordinator"
      metadata:
        initiated_by: "user:admin@example.com"
        source: "api:deployment-service"
        priority: 8
        tags:
          - "deployment"
          - "production"
          - "critical"

  - name: saga_transaction
    description: Saga pattern for long-running workflow
    data:
      transaction_id: "660e8400-e29b-41d4-a716-446655440005"
      name: "Process Data Pipeline"
      type: "saga"
      pattern: "saga"
      status: "committed"
      operations:
        - operation_id: "990e8400-e29b-41d4-a716-446655440006"
          type: "execute"
          resource:
            id: "pipeline:data-ingestion"
            type: "data_pipeline"
          action:
            method: "ingest_data"
          status: "completed"
          order: 1
          started_at: "2025-01-11T10:00:00Z"
          completed_at: "2025-01-11T10:10:00Z"
          duration: 600000
        - operation_id: "990e8400-e29b-41d4-a716-446655440007"
          type: "execute"
          resource:
            id: "pipeline:data-transformation"
            type: "data_pipeline"
          action:
            method: "transform_data"
          status: "completed"
          order: 2
          dependencies:
            - "990e8400-e29b-41d4-a716-446655440006"
          started_at: "2025-01-11T10:10:05Z"
          completed_at: "2025-01-11T10:25:00Z"
          duration: 895000
      saga:
        saga_id: "aa0e8400-e29b-41d4-a716-446655440008"
        steps:
          - step_id: "bb0e8400-e29b-41d4-a716-446655440009"
            operation_id: "990e8400-e29b-41d4-a716-446655440006"
            compensation_id: "cc0e8400-e29b-41d4-a716-446655440010"
            status: "completed"
          - step_id: "bb0e8400-e29b-41d4-a716-446655440011"
            operation_id: "990e8400-e29b-41d4-a716-446655440007"
            compensation_id: "cc0e8400-e29b-41d4-a716-446655440012"
            status: "completed"
        compensation_strategy: "backward"
      created_at: "2025-01-11T09:59:55Z"
      started_at: "2025-01-11T10:00:00Z"
      committed_at: "2025-01-11T10:25:00Z"
      duration: 1500000
      metadata:
        initiated_by: "system:scheduler"
        source: "cron:daily-pipeline"
        tags:
          - "data-pipeline"
          - "scheduled"

# Integration Guidelines
integration:
  creation:
    - Define transaction boundaries
    - Identify operations and dependencies
    - Set appropriate isolation level
    - Configure timeout and retry policies
    - Implement compensation logic
  
  execution:
    - Begin transaction
    - Execute operations in order
    - Handle failures gracefully
    - Commit or abort atomically
    - Release locks
  
  monitoring:
    - Track transaction progress
    - Monitor lock contention
    - Alert on long-running transactions
    - Measure commit/abort rates
    - Analyze performance bottlenecks

# Performance Considerations
performance:
  locking:
    - Use appropriate lock granularity
    - Minimize lock duration
    - Implement deadlock detection
    - Use optimistic locking when possible
  
  distributed:
    - Minimize network round trips
    - Use asynchronous communication
    - Implement timeout handling
    - Cache participant information
  
  saga:
    - Design idempotent operations
    - Implement efficient compensation
    - Use event sourcing for state
    - Parallelize independent steps