# MCP Level 3 - Promotion Engine: Deployment Manifest Schema
# Purpose: Define deployment configurations and specifications for artifact deployment
# Version: 1.0.0
# Last Updated: 2025-01-11

schema:
  name: deployment-manifest
  version: "1.0.0"
  namespace: mcp.level3.promotion.artifacts
  description: |
    Deployment manifest artifact for defining deployment configurations and specifications.
    Supports multiple deployment targets, resource allocation, and environment configurations.
    Enables infrastructure-as-code, GitOps workflows, and automated deployments.

  type: object
  required:
    - manifest_id
    - name
    - version
    - artifact_id
    - target_environment
    - deployment_spec
    - created_at
  
  properties:
    # Core Identity
    manifest_id:
      type: string
      format: uuid
      description: Unique manifest identifier
      example: "550e8400-e29b-41d4-a716-446655440000"
      index: true
    
    name:
      type: string
      description: Manifest name
      example: "ml-model-production-deployment"
      minLength: 3
      maxLength: 200
      pattern: '^[a-z][a-z0-9-]*$'
    
    version:
      type: string
      pattern: '^\d+\.\d+\.\d+$'
      description: Manifest version
      example: "1.0.0"
    
    description:
      type: string
      description: Detailed manifest description
      example: "Production deployment configuration for ML model v2.1.0"
      maxLength: 2000
      optional: true
    
    # Artifact Reference
    artifact_id:
      type: string
      format: uuid
      description: ID of artifact to deploy
      example: "660e8400-e29b-41d4-a716-446655440001"
      index: true
    
    artifact_version:
      type: string
      description: Artifact version to deploy
      example: "2.1.0"
      pattern: '^\d+\.\d+\.\d+$'
    
    artifact_type:
      type: string
      description: Type of artifact
      example: "ml_model"
      enum:
        - ml_model
        - dataset
        - pipeline
        - service
        - application
        - library
        - container
    
    # Target Environment
    target_environment:
      type: string
      description: Target deployment environment
      example: "production"
      enum:
        - development
        - testing
        - staging
        - pre_production
        - production
        - canary
      index: true
    
    target_region:
      type: string
      description: Target deployment region
      example: "us-east-1"
      optional: true
    
    target_cluster:
      type: string
      description: Target cluster identifier
      example: "prod-cluster-01"
      optional: true
    
    # Deployment Specification
    deployment_spec:
      type: object
      description: Deployment specification
      required:
        - platform
        - strategy
      properties:
        platform:
          type: string
          enum:
            - kubernetes
            - docker
            - aws_ecs
            - aws_lambda
            - azure_functions
            - google_cloud_run
            - openshift
            - nomad
            - vm
            - bare_metal
          description: Deployment platform
          example: "kubernetes"
        
        strategy:
          type: string
          enum:
            - recreate
            - rolling_update
            - blue_green
            - canary
            - shadow
            - a_b_testing
          description: Deployment strategy
          example: "canary"
        
        replicas:
          type: integer
          minimum: 0
          description: Number of replicas
          example: 3
          default: 1
        
        # Resource Requirements
        resources:
          type: object
          description: Resource requirements
          properties:
            requests:
              type: object
              description: Minimum resource requests
              properties:
                cpu:
                  type: string
                  description: CPU request
                  example: "1000m"
                memory:
                  type: string
                  description: Memory request
                  example: "2Gi"
                gpu:
                  type: integer
                  description: GPU count
                  example: 1
                  optional: true
                storage:
                  type: string
                  description: Storage request
                  example: "10Gi"
                  optional: true
            
            limits:
              type: object
              description: Maximum resource limits
              properties:
                cpu:
                  type: string
                  description: CPU limit
                  example: "2000m"
                memory:
                  type: string
                  description: Memory limit
                  example: "4Gi"
                gpu:
                  type: integer
                  description: GPU limit
                  example: 1
                  optional: true
        
        # Container Configuration
        container:
          type: object
          description: Container configuration
          optional: true
          properties:
            image:
              type: string
              description: Container image
              example: "registry.example.com/ml-model:2.1.0"
            
            image_pull_policy:
              type: string
              enum:
                - Always
                - IfNotPresent
                - Never
              description: Image pull policy
              example: "IfNotPresent"
              default: "IfNotPresent"
            
            command:
              type: array
              items:
                type: string
              description: Container command
              example:
                - "python"
                - "serve.py"
              optional: true
            
            args:
              type: array
              items:
                type: string
              description: Container arguments
              example:
                - "--port=8080"
                - "--workers=4"
              optional: true
            
            ports:
              type: array
              description: Container ports
              items:
                type: object
                properties:
                  name:
                    type: string
                    description: Port name
                  container_port:
                    type: integer
                    minimum: 1
                    maximum: 65535
                    description: Container port number
                  protocol:
                    type: string
                    enum:
                      - TCP
                      - UDP
                    description: Port protocol
                    default: "TCP"
              example:
                - name: "http"
                  container_port: 8080
                  protocol: "TCP"
            
            env:
              type: array
              description: Environment variables
              items:
                type: object
                properties:
                  name:
                    type: string
                    description: Variable name
                  value:
                    type: string
                    description: Variable value
                  value_from:
                    type: object
                    description: Value from secret/configmap
                    optional: true
              example:
                - name: "MODEL_VERSION"
                  value: "2.1.0"
                - name: "LOG_LEVEL"
                  value: "INFO"
              optional: true
            
            volume_mounts:
              type: array
              description: Volume mounts
              items:
                type: object
                properties:
                  name:
                    type: string
                    description: Volume name
                  mount_path:
                    type: string
                    description: Mount path in container
                  read_only:
                    type: boolean
                    description: Read-only mount
                    default: false
              optional: true
        
        # Volumes
        volumes:
          type: array
          description: Volume definitions
          items:
            type: object
            properties:
              name:
                type: string
                description: Volume name
              type:
                type: string
                enum:
                  - empty_dir
                  - host_path
                  - persistent_volume_claim
                  - config_map
                  - secret
                  - nfs
                  - aws_ebs
                  - azure_disk
                  - gce_persistent_disk
                description: Volume type
              config:
                type: object
                description: Volume configuration
                additionalProperties: true
          optional: true
        
        # Health Checks
        health_checks:
          type: object
          description: Health check configuration
          optional: true
          properties:
            liveness_probe:
              type: object
              description: Liveness probe
              properties:
                type:
                  type: string
                  enum:
                    - http
                    - tcp
                    - exec
                  description: Probe type
                path:
                  type: string
                  description: HTTP path
                  optional: true
                port:
                  type: integer
                  description: Port number
                  optional: true
                initial_delay_seconds:
                  type: integer
                  minimum: 0
                  description: Initial delay
                  default: 30
                period_seconds:
                  type: integer
                  minimum: 1
                  description: Check period
                  default: 10
                timeout_seconds:
                  type: integer
                  minimum: 1
                  description: Timeout
                  default: 5
                success_threshold:
                  type: integer
                  minimum: 1
                  description: Success threshold
                  default: 1
                failure_threshold:
                  type: integer
                  minimum: 1
                  description: Failure threshold
                  default: 3
            
            readiness_probe:
              type: object
              description: Readiness probe
              properties:
                type:
                  type: string
                  enum:
                    - http
                    - tcp
                    - exec
                  description: Probe type
                path:
                  type: string
                  description: HTTP path
                  optional: true
                port:
                  type: integer
                  description: Port number
                  optional: true
                initial_delay_seconds:
                  type: integer
                  minimum: 0
                  description: Initial delay
                  default: 10
                period_seconds:
                  type: integer
                  minimum: 1
                  description: Check period
                  default: 10
                timeout_seconds:
                  type: integer
                  minimum: 1
                  description: Timeout
                  default: 5
                success_threshold:
                  type: integer
                  minimum: 1
                  description: Success threshold
                  default: 1
                failure_threshold:
                  type: integer
                  minimum: 1
                  description: Failure threshold
                  default: 3
        
        # Autoscaling
        autoscaling:
          type: object
          description: Autoscaling configuration
          optional: true
          properties:
            enabled:
              type: boolean
              description: Enable autoscaling
              default: false
            
            min_replicas:
              type: integer
              minimum: 1
              description: Minimum replicas
              example: 2
            
            max_replicas:
              type: integer
              minimum: 1
              description: Maximum replicas
              example: 10
            
            metrics:
              type: array
              description: Scaling metrics
              items:
                type: object
                properties:
                  type:
                    type: string
                    enum:
                      - cpu
                      - memory
                      - custom
                    description: Metric type
                  target_value:
                    type: number
                    description: Target metric value
                  target_type:
                    type: string
                    enum:
                      - utilization
                      - average_value
                    description: Target type
              example:
                - type: "cpu"
                  target_value: 80
                  target_type: "utilization"
        
        # Network Configuration
        networking:
          type: object
          description: Network configuration
          optional: true
          properties:
            service_type:
              type: string
              enum:
                - ClusterIP
                - NodePort
                - LoadBalancer
                - ExternalName
              description: Service type
              example: "LoadBalancer"
            
            ports:
              type: array
              description: Service ports
              items:
                type: object
                properties:
                  name:
                    type: string
                  port:
                    type: integer
                  target_port:
                    type: integer
                  protocol:
                    type: string
                    enum:
                      - TCP
                      - UDP
            
            ingress:
              type: object
              description: Ingress configuration
              optional: true
              properties:
                enabled:
                  type: boolean
                  default: false
                host:
                  type: string
                  description: Ingress host
                path:
                  type: string
                  description: Ingress path
                tls:
                  type: boolean
                  description: Enable TLS
                  default: false
                annotations:
                  type: object
                  additionalProperties: true
    
    # Configuration
    configuration:
      type: object
      description: Application configuration
      optional: true
      properties:
        config_maps:
          type: array
          description: ConfigMap references
          items:
            type: object
            properties:
              name:
                type: string
              data:
                type: object
                additionalProperties: true
          optional: true
        
        secrets:
          type: array
          description: Secret references
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
                enum:
                  - Opaque
                  - kubernetes.io/tls
                  - kubernetes.io/dockerconfigjson
              data:
                type: object
                additionalProperties: true
          optional: true
    
    # Dependencies
    dependencies:
      type: array
      description: Deployment dependencies
      items:
        type: object
        properties:
          name:
            type: string
            description: Dependency name
          type:
            type: string
            enum:
              - service
              - database
              - cache
              - queue
              - storage
            description: Dependency type
          required:
            type: boolean
            description: Whether dependency is required
            default: true
          health_check:
            type: object
            description: Dependency health check
            optional: true
      optional: true
    
    # Rollout Configuration
    rollout:
      type: object
      description: Rollout configuration
      optional: true
      properties:
        max_surge:
          type: string
          description: Maximum surge during rollout
          example: "25%"
        
        max_unavailable:
          type: string
          description: Maximum unavailable during rollout
          example: "25%"
        
        pause_duration:
          type: integer
          minimum: 0
          description: Pause duration between steps in seconds
          example: 60
        
        rollback_on_failure:
          type: boolean
          description: Automatic rollback on failure
          default: true
    
    # Status
    status:
      type: string
      enum:
        - draft
        - validated
        - approved
        - active
        - deprecated
        - archived
      description: Manifest status
      example: "active"
      default: "draft"
    
    # Metadata
    metadata:
      type: object
      description: Additional metadata
      optional: true
      properties:
        owner:
          type: string
          description: Manifest owner
          example: "team:platform"
        
        maintainers:
          type: array
          items:
            type: string
          description: Maintainers
          example:
            - "user:admin@example.com"
        
        labels:
          type: object
          additionalProperties: true
          description: Kubernetes-style labels
          example:
            app: "ml-model"
            version: "2.1.0"
            environment: "production"
        
        annotations:
          type: object
          additionalProperties: true
          description: Kubernetes-style annotations
          example:
            deployment.kubernetes.io/revision: "3"
        
        tags:
          type: array
          items:
            type: string
          description: Classification tags
          example:
            - "ml-model"
            - "production"
            - "critical"
        
        documentation_url:
          type: string
          format: uri
          description: Documentation URL
          optional: true
    
    # Timestamps
    created_at:
      type: string
      format: date-time
      description: Creation timestamp
      example: "2025-01-01T00:00:00Z"
      index: true
    
    updated_at:
      type: string
      format: date-time
      description: Last update timestamp
      example: "2025-01-11T10:00:00Z"
      optional: true
    
    last_deployed_at:
      type: string
      format: date-time
      description: Last deployment timestamp
      example: "2025-01-11T10:05:00Z"
      optional: true

  # Validation Rules
  validation:
    rules:
      - name: valid_name_format
        condition: name matches pattern
        message: "Name must be lowercase with hyphens"
        severity: error
      
      - name: valid_versions
        condition: version and artifact_version match semantic versioning
        message: "Versions must follow semantic versioning"
        severity: error
      
      - name: valid_replicas
        condition: deployment_spec.replicas >= 0
        message: "Replicas must be non-negative"
        severity: error
      
      - name: valid_resource_limits
        condition: resources.limits >= resources.requests
        message: "Resource limits must be greater than or equal to requests"
        severity: warning
      
      - name: valid_autoscaling
        condition: autoscaling.max_replicas >= autoscaling.min_replicas
        message: "Max replicas must be greater than or equal to min replicas"
        severity: error

  # Indexes
  indexes:
    - fields: [manifest_id]
      unique: true
    - fields: [name, version]
    - fields: [artifact_id, target_environment]
    - fields: [status]
    - fields: [created_at]

# Usage Examples
examples:
  - name: kubernetes_ml_model_deployment
    description: Kubernetes deployment manifest for ML model
    data:
      manifest_id: "550e8400-e29b-41d4-a716-446655440000"
      name: "ml-model-production-deployment"
      version: "1.0.0"
      description: "Production deployment configuration for ML model v2.1.0"
      artifact_id: "660e8400-e29b-41d4-a716-446655440001"
      artifact_version: "2.1.0"
      artifact_type: "ml_model"
      target_environment: "production"
      target_region: "us-east-1"
      target_cluster: "prod-cluster-01"
      deployment_spec:
        platform: "kubernetes"
        strategy: "canary"
        replicas: 3
        resources:
          requests:
            cpu: "1000m"
            memory: "2Gi"
            gpu: 1
          limits:
            cpu: "2000m"
            memory: "4Gi"
            gpu: 1
        container:
          image: "registry.example.com/ml-model:2.1.0"
          image_pull_policy: "IfNotPresent"
          command:
            - "python"
            - "serve.py"
          args:
            - "--port=8080"
            - "--workers=4"
          ports:
            - name: "http"
              container_port: 8080
              protocol: "TCP"
          env:
            - name: "MODEL_VERSION"
              value: "2.1.0"
            - name: "LOG_LEVEL"
              value: "INFO"
            - name: "ENVIRONMENT"
              value: "production"
        health_checks:
          liveness_probe:
            type: "http"
            path: "/health"
            port: 8080
            initial_delay_seconds: 30
            period_seconds: 10
            timeout_seconds: 5
            failure_threshold: 3
          readiness_probe:
            type: "http"
            path: "/ready"
            port: 8080
            initial_delay_seconds: 10
            period_seconds: 5
            timeout_seconds: 3
            failure_threshold: 3
        autoscaling:
          enabled: true
          min_replicas: 2
          max_replicas: 10
          metrics:
            - type: "cpu"
              target_value: 80
              target_type: "utilization"
            - type: "memory"
              target_value: 80
              target_type: "utilization"
        networking:
          service_type: "LoadBalancer"
          ports:
            - name: "http"
              port: 80
              target_port: 8080
              protocol: "TCP"
          ingress:
            enabled: true
            host: "api.example.com"
            path: "/v2/predict"
            tls: true
      rollout:
        max_surge: "25%"
        max_unavailable: "25%"
        pause_duration: 60
        rollback_on_failure: true
      status: "active"
      metadata:
        owner: "team:ml-platform"
        maintainers:
          - "user:admin@example.com"
        labels:
          app: "ml-model"
          version: "2.1.0"
          environment: "production"
        tags:
          - "ml-model"
          - "production"
          - "critical"
      created_at: "2025-01-01T00:00:00Z"
      updated_at: "2025-01-11T10:00:00Z"
      last_deployed_at: "2025-01-11T10:05:00Z"

# Integration Guidelines
integration:
  creation:
    - Define clear deployment specifications
    - Set appropriate resource limits
    - Configure health checks
    - Implement autoscaling
    - Document dependencies
  
  deployment:
    - Validate manifest before deployment
    - Apply deployment strategy
    - Monitor rollout progress
    - Verify health checks
    - Handle failures gracefully
  
  maintenance:
    - Version control manifests
    - Review resource usage
    - Update configurations
    - Test changes in staging
    - Document changes

# Performance Considerations
performance:
  resource_allocation:
    - Right-size resource requests
    - Set appropriate limits
    - Monitor actual usage
    - Adjust based on metrics
  
  scaling:
    - Configure autoscaling appropriately
    - Set realistic min/max replicas
    - Use appropriate scaling metrics
    - Test scaling behavior
  
  deployment:
    - Use efficient rollout strategies
    - Minimize downtime
    - Implement proper health checks
    - Monitor deployment progress