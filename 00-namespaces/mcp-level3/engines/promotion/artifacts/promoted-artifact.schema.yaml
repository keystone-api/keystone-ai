# MCP Level 3 - Promotion Engine: Promoted Artifact Schema
# Purpose: Define promoted artifacts that have passed validation and are ready for deployment
# Version: 1.0.0
# Last Updated: 2025-01-11

schema:
  name: promoted-artifact
  version: "1.0.0"
  namespace: mcp.level3.promotion.artifacts
  description: |
    Promoted artifact representing a validated and approved artifact ready for deployment.
    Tracks promotion history, approval workflows, and deployment readiness.
    Supports multi-stage promotions, canary releases, and rollback capabilities.

  type: object
  required:
    - promotion_id
    - artifact_id
    - source_environment
    - target_environment
    - status
    - promoted_at
  
  properties:
    # Core Identity
    promotion_id:
      type: string
      format: uuid
      description: Unique promotion identifier
      example: "550e8400-e29b-41d4-a716-446655440000"
      index: true
    
    artifact_id:
      type: string
      format: uuid
      description: ID of the artifact being promoted
      example: "660e8400-e29b-41d4-a716-446655440001"
      index: true
    
    artifact_version:
      type: string
      description: Version of the artifact
      example: "2.1.0"
      pattern: '^\d+\.\d+\.\d+$'
    
    artifact_type:
      type: string
      description: Type of artifact
      example: "ml_model"
      enum:
        - ml_model
        - dataset
        - pipeline
        - config
        - library
        - container
        - package
    
    # Promotion Path
    source_environment:
      type: string
      description: Source environment
      example: "staging"
      enum:
        - development
        - testing
        - staging
        - pre_production
        - production
        - canary
    
    target_environment:
      type: string
      description: Target environment
      example: "production"
      enum:
        - development
        - testing
        - staging
        - pre_production
        - production
        - canary
    
    promotion_stage:
      type: string
      description: Current promotion stage
      example: "production"
      optional: true
    
    # Promotion Strategy
    strategy:
      type: object
      description: Promotion strategy configuration
      optional: true
      properties:
        type:
          type: string
          enum:
            - direct
            - blue_green
            - canary
            - rolling
            - shadow
          description: Deployment strategy
          example: "canary"
          default: "direct"
        
        canary_config:
          type: object
          description: Canary deployment configuration
          optional: true
          properties:
            initial_traffic_percent:
              type: number
              minimum: 0
              maximum: 100
              description: Initial traffic percentage
              example: 10
            
            increment_percent:
              type: number
              minimum: 0
              maximum: 100
              description: Traffic increment per step
              example: 10
            
            increment_interval:
              type: integer
              minimum: 1
              description: Interval between increments in seconds
              example: 300
            
            success_criteria:
              type: object
              description: Criteria for successful canary
              properties:
                error_rate_threshold:
                  type: number
                  description: Maximum acceptable error rate
                  example: 0.01
                latency_p95_threshold:
                  type: number
                  description: Maximum P95 latency in ms
                  example: 500
                min_duration:
                  type: integer
                  description: Minimum duration before promotion in seconds
                  example: 600
        
        rollback_config:
          type: object
          description: Automatic rollback configuration
          optional: true
          properties:
            enabled:
              type: boolean
              description: Enable automatic rollback
              default: true
            
            triggers:
              type: array
              items:
                type: string
              description: Conditions that trigger rollback
              example:
                - "error_rate > 0.05"
                - "latency_p95 > 1000"
    
    # Validation Results
    validation:
      type: object
      description: Validation results before promotion
      optional: true
      properties:
        passed:
          type: boolean
          description: Whether validation passed
          example: true
        
        validation_id:
          type: string
          format: uuid
          description: Validation report ID
          example: "770e8400-e29b-41d4-a716-446655440002"
        
        score:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: Overall validation score
          example: 0.95
        
        checks:
          type: array
          description: Individual validation checks
          items:
            type: object
            properties:
              name:
                type: string
                description: Check name
              passed:
                type: boolean
                description: Whether check passed
              score:
                type: number
                description: Check score
              message:
                type: string
                description: Check result message
          example:
            - name: "model_accuracy"
              passed: true
              score: 0.96
              message: "Model accuracy meets threshold"
            - name: "data_quality"
              passed: true
              score: 0.98
              message: "Data quality checks passed"
    
    # Approval Workflow
    approvals:
      type: array
      description: Approval records
      items:
        type: object
        required:
          - approver
          - status
          - timestamp
        properties:
          approval_id:
            type: string
            format: uuid
            description: Approval record ID
            example: "880e8400-e29b-41d4-a716-446655440003"
          
          approver:
            type: object
            description: Approver information
            required:
              - id
              - type
            properties:
              id:
                type: string
                description: Approver identifier
                example: "user:admin@example.com"
              type:
                type: string
                enum:
                  - user
                  - team
                  - system
                description: Approver type
                example: "user"
              name:
                type: string
                description: Approver name
                example: "Admin User"
          
          status:
            type: string
            enum:
              - pending
              - approved
              - rejected
              - expired
            description: Approval status
            example: "approved"
          
          timestamp:
            type: string
            format: date-time
            description: Approval timestamp
            example: "2025-01-11T10:00:00Z"
          
          comment:
            type: string
            description: Approval comment
            example: "Approved after successful validation"
            optional: true
          
          required:
            type: boolean
            description: Whether this approval is required
            default: true
      optional: true
    
    # Deployment Information
    deployment:
      type: object
      description: Deployment information
      optional: true
      properties:
        deployment_id:
          type: string
          format: uuid
          description: Deployment record ID
          example: "990e8400-e29b-41d4-a716-446655440004"
        
        method:
          type: string
          enum:
            - kubernetes
            - docker
            - serverless
            - vm
            - bare_metal
          description: Deployment method
          example: "kubernetes"
        
        location:
          type: string
          description: Deployment location
          example: "us-east-1"
        
        replicas:
          type: integer
          minimum: 0
          description: Number of replicas
          example: 3
        
        resources:
          type: object
          description: Resource allocation
          optional: true
          properties:
            cpu:
              type: string
              description: CPU allocation
              example: "2000m"
            memory:
              type: string
              description: Memory allocation
              example: "4Gi"
            gpu:
              type: integer
              description: GPU count
              example: 1
              optional: true
        
        endpoints:
          type: array
          items:
            type: string
            format: uri
          description: Deployment endpoints
          example:
            - "https://api.example.com/v2"
          optional: true
    
    # Status
    status:
      type: string
      enum:
        - pending_approval
        - approved
        - rejected
        - in_progress
        - deployed
        - failed
        - rolled_back
        - cancelled
      description: Promotion status
      example: "deployed"
      index: true
    
    # Health Monitoring
    health:
      type: object
      description: Post-deployment health status
      optional: true
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
            - unknown
          description: Health status
          example: "healthy"
        
        last_check:
          type: string
          format: date-time
          description: Last health check timestamp
          example: "2025-01-11T10:30:00Z"
        
        metrics:
          type: object
          description: Health metrics
          optional: true
          properties:
            error_rate:
              type: number
              description: Current error rate
              example: 0.001
            latency_p95:
              type: number
              description: P95 latency in milliseconds
              example: 150
            throughput:
              type: number
              description: Requests per second
              example: 1000
            availability:
              type: number
              minimum: 0.0
              maximum: 1.0
              description: Availability percentage
              example: 0.999
        
        issues:
          type: array
          items:
            type: object
            properties:
              severity:
                type: string
                enum:
                  - critical
                  - warning
                  - info
              message:
                type: string
              detected_at:
                type: string
                format: date-time
          description: Detected issues
          optional: true
    
    # Rollback Information
    rollback:
      type: object
      description: Rollback information if applicable
      optional: true
      properties:
        rolled_back:
          type: boolean
          description: Whether promotion was rolled back
          example: false
        
        rollback_reason:
          type: string
          description: Reason for rollback
          optional: true
        
        rollback_timestamp:
          type: string
          format: date-time
          description: Rollback timestamp
          optional: true
        
        rollback_to_version:
          type: string
          description: Version rolled back to
          optional: true
        
        automatic:
          type: boolean
          description: Whether rollback was automatic
          optional: true
    
    # Timing
    promoted_at:
      type: string
      format: date-time
      description: Promotion timestamp
      example: "2025-01-11T10:00:00Z"
      index: true
    
    deployed_at:
      type: string
      format: date-time
      description: Deployment timestamp
      example: "2025-01-11T10:05:00Z"
      optional: true
    
    completed_at:
      type: string
      format: date-time
      description: Completion timestamp
      example: "2025-01-11T10:10:00Z"
      optional: true
    
    # Metadata
    metadata:
      type: object
      description: Additional metadata
      optional: true
      properties:
        promoted_by:
          type: string
          description: Who initiated the promotion
          example: "user:admin@example.com"
        
        promotion_reason:
          type: string
          description: Reason for promotion
          example: "New model version with improved accuracy"
        
        change_ticket:
          type: string
          description: Change management ticket
          example: "CHG-12345"
        
        release_notes:
          type: string
          description: Release notes
          example: "Version 2.1.0 includes improved accuracy and reduced latency"
        
        tags:
          type: array
          items:
            type: string
          description: Classification tags
          example:
            - "ml-model"
            - "production"
            - "critical"
        
        custom:
          type: object
          description: Custom metadata
          additionalProperties: true

  # Validation Rules
  validation:
    rules:
      - name: valid_promotion_path
        condition: source_environment != target_environment
        message: "Source and target environments must be different"
        severity: error
      
      - name: valid_version
        condition: artifact_version matches semantic versioning
        message: "Artifact version must follow semantic versioning"
        severity: error
      
      - name: approvals_required
        condition: has_required_approvals()
        message: "All required approvals must be obtained"
        severity: error
      
      - name: validation_passed
        condition: validation.passed == true || validation == null
        message: "Validation must pass before promotion"
        severity: error
      
      - name: timing_consistency
        condition: promoted_at <= deployed_at && deployed_at <= completed_at
        message: "Timestamps must be in chronological order"
        severity: error

  # Indexes
  indexes:
    - fields: [promotion_id]
      unique: true
    - fields: [artifact_id, target_environment]
    - fields: [status, promoted_at]
    - fields: [target_environment, status]
    - fields: [promoted_at]

# Usage Examples
examples:
  - name: ml_model_canary_promotion
    description: ML model promotion with canary deployment
    data:
      promotion_id: "550e8400-e29b-41d4-a716-446655440000"
      artifact_id: "660e8400-e29b-41d4-a716-446655440001"
      artifact_version: "2.1.0"
      artifact_type: "ml_model"
      source_environment: "staging"
      target_environment: "production"
      promotion_stage: "production"
      strategy:
        type: "canary"
        canary_config:
          initial_traffic_percent: 10
          increment_percent: 10
          increment_interval: 300
          success_criteria:
            error_rate_threshold: 0.01
            latency_p95_threshold: 500
            min_duration: 600
        rollback_config:
          enabled: true
          triggers:
            - "error_rate > 0.05"
            - "latency_p95 > 1000"
      validation:
        passed: true
        validation_id: "770e8400-e29b-41d4-a716-446655440002"
        score: 0.95
        checks:
          - name: "model_accuracy"
            passed: true
            score: 0.96
            message: "Model accuracy meets threshold"
          - name: "data_quality"
            passed: true
            score: 0.98
            message: "Data quality checks passed"
          - name: "performance_test"
            passed: true
            score: 0.94
            message: "Performance within acceptable limits"
      approvals:
        - approval_id: "880e8400-e29b-41d4-a716-446655440003"
          approver:
            id: "user:admin@example.com"
            type: "user"
            name: "Admin User"
          status: "approved"
          timestamp: "2025-01-11T10:00:00Z"
          comment: "Approved after successful validation"
          required: true
        - approval_id: "880e8400-e29b-41d4-a716-446655440004"
          approver:
            id: "team:ml-platform"
            type: "team"
            name: "ML Platform Team"
          status: "approved"
          timestamp: "2025-01-11T10:02:00Z"
          required: true
      deployment:
        deployment_id: "990e8400-e29b-41d4-a716-446655440005"
        method: "kubernetes"
        location: "us-east-1"
        replicas: 3
        resources:
          cpu: "2000m"
          memory: "4Gi"
          gpu: 1
        endpoints:
          - "https://api.example.com/v2/predict"
      status: "deployed"
      health:
        status: "healthy"
        last_check: "2025-01-11T10:30:00Z"
        metrics:
          error_rate: 0.001
          latency_p95: 150
          throughput: 1000
          availability: 0.999
      promoted_at: "2025-01-11T10:00:00Z"
      deployed_at: "2025-01-11T10:05:00Z"
      completed_at: "2025-01-11T10:10:00Z"
      metadata:
        promoted_by: "user:admin@example.com"
        promotion_reason: "New model version with improved accuracy"
        change_ticket: "CHG-12345"
        release_notes: "Version 2.1.0 includes improved accuracy (96%) and reduced latency (150ms P95)"
        tags:
          - "ml-model"
          - "production"
          - "critical"

  - name: failed_promotion_with_rollback
    description: Failed promotion that was rolled back
    data:
      promotion_id: "aa0e8400-e29b-41d4-a716-446655440006"
      artifact_id: "bb0e8400-e29b-41d4-a716-446655440007"
      artifact_version: "2.2.0"
      artifact_type: "ml_model"
      source_environment: "staging"
      target_environment: "production"
      strategy:
        type: "canary"
        rollback_config:
          enabled: true
          triggers:
            - "error_rate > 0.05"
      status: "rolled_back"
      health:
        status: "unhealthy"
        last_check: "2025-01-11T11:15:00Z"
        metrics:
          error_rate: 0.08
          latency_p95: 1200
          throughput: 500
          availability: 0.92
        issues:
          - severity: "critical"
            message: "Error rate exceeded threshold (8% > 5%)"
            detected_at: "2025-01-11T11:10:00Z"
          - severity: "critical"
            message: "Latency P95 exceeded threshold (1200ms > 1000ms)"
            detected_at: "2025-01-11T11:12:00Z"
      rollback:
        rolled_back: true
        rollback_reason: "Automatic rollback triggered due to high error rate and latency"
        rollback_timestamp: "2025-01-11T11:15:00Z"
        rollback_to_version: "2.1.0"
        automatic: true
      promoted_at: "2025-01-11T11:00:00Z"
      deployed_at: "2025-01-11T11:05:00Z"
      completed_at: "2025-01-11T11:15:00Z"
      metadata:
        promoted_by: "user:developer@example.com"
        tags:
          - "ml-model"
          - "production"
          - "failed"

# Integration Guidelines
integration:
  promotion:
    - Validate artifact before promotion
    - Obtain required approvals
    - Execute promotion strategy
    - Monitor health post-deployment
    - Implement automatic rollback
  
  monitoring:
    - Track promotion metrics
    - Monitor health indicators
    - Alert on issues
    - Log all events
    - Maintain audit trail
  
  rollback:
    - Define rollback triggers
    - Implement automatic rollback
    - Preserve rollback history
    - Notify stakeholders
    - Document lessons learned

# Performance Considerations
performance:
  deployment:
    - Use efficient deployment strategies
    - Minimize downtime
    - Implement health checks
    - Monitor resource usage
  
  monitoring:
    - Real-time health monitoring
    - Efficient metric collection
    - Fast anomaly detection
    - Quick rollback execution