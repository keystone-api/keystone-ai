# MCP Level 3 - Promotion Engine Manifest
# Purpose: Define Promotion engine capabilities and configuration
# Version: 1.0.0
# Last Updated: 2025-01-11

manifest:
  # Core Metadata
  name: promotion-engine
  version: "1.0.0"
  namespace: mcp.level3.engines.promotion
  description: |
    Promotion Engine for artifact promotion and deployment management.
    Supports multi-stage promotions, approval workflows, and deployment strategies.
    Enables canary deployments, blue-green deployments, and automatic rollback.
  
  # Engine Type
  type: deployment_management
  category: release_orchestration
  
  # Capabilities
  capabilities:
    # Promotion Management
    promotion_management:
      enabled: true
      description: Manage artifact promotions
      features:
        - promotion_planning
        - approval_workflow
        - promotion_execution
        - promotion_tracking
        - promotion_history
      promotion_stages:
        - development
        - testing
        - staging
        - pre_production
        - production
        - canary
    
    # Deployment Strategies
    deployment_strategies:
      enabled: true
      description: Multiple deployment strategies
      features:
        - blue_green_deployment
        - canary_deployment
        - rolling_deployment
        - shadow_deployment
        - a_b_testing
      strategy_types:
        - recreate
        - rolling_update
        - blue_green
        - canary
        - shadow
    
    # Approval Workflow
    approval_workflow:
      enabled: true
      description: Multi-level approval process
      features:
        - approval_request
        - approval_tracking
        - multi_approver_support
        - conditional_approval
        - automatic_approval
      approval_types:
        - manual
        - automatic
        - conditional
        - time_based
    
    # Health Monitoring
    health_monitoring:
      enabled: true
      description: Post-deployment health checks
      features:
        - health_check_execution
        - metric_monitoring
        - error_rate_tracking
        - latency_monitoring
        - availability_tracking
      monitoring_types:
        - synthetic_monitoring
        - real_user_monitoring
        - application_performance_monitoring
    
    # Rollback Management
    rollback_management:
      enabled: true
      description: Automatic and manual rollback
      features:
        - automatic_rollback
        - manual_rollback
        - rollback_validation
        - rollback_history
      rollback_triggers:
        - error_rate_threshold
        - latency_threshold
        - availability_threshold
        - manual_trigger
    
    # Deployment Manifest
    manifest_management:
      enabled: true
      description: Deployment configuration management
      features:
        - manifest_creation
        - manifest_validation
        - manifest_versioning
        - manifest_templating
      manifest_formats:
        - kubernetes
        - docker_compose
        - terraform
        - cloudformation
  
  # Interfaces
  interfaces:
    # REST API
    rest_api:
      enabled: true
      base_path: /api/v1/promotion
      endpoints:
        - path: /promotions
          method: POST
          description: Create promotion plan
          input_schema: promotion-plan
          output_schema: promotion-response
        
        - path: /promotions/{promotion_id}
          method: GET
          description: Get promotion status
          output_schema: promoted-artifact
        
        - path: /promotions/{promotion_id}/approve
          method: POST
          description: Approve promotion
          input_schema: approval-request
          output_schema: approval-record
        
        - path: /promotions/{promotion_id}/execute
          method: POST
          description: Execute promotion
          output_schema: execution-response
        
        - path: /promotions/{promotion_id}/rollback
          method: POST
          description: Rollback promotion
          input_schema: rollback-request
          output_schema: rollback-response
        
        - path: /deployments
          method: POST
          description: Create deployment
          input_schema: deployment-manifest
          output_schema: deployment-response
        
        - path: /deployments/{deployment_id}
          method: GET
          description: Get deployment status
          output_schema: deployment-status
        
        - path: /deployments/{deployment_id}/health
          method: GET
          description: Get deployment health
          output_schema: health-status
    
    # gRPC API
    grpc_api:
      enabled: true
      service: PromotionService
      methods:
        - CreatePromotion
        - GetPromotion
        - ApprovePromotion
        - ExecutePromotion
        - RollbackPromotion
        - CreateDeployment
        - GetDeployment
        - GetHealth
    
    # Event Streaming
    event_streaming:
      enabled: true
      protocols:
        - kafka
        - rabbitmq
        - redis_streams
      topics:
        - promotion.created
        - promotion.approved
        - promotion.rejected
        - promotion.executed
        - promotion.completed
        - promotion.failed
        - promotion.rolled_back
        - deployment.started
        - deployment.completed
        - deployment.failed
  
  # Dependencies
  dependencies:
    # Required Services
    required_services:
      - name: deployment_platform
        type: service
        description: Target deployment platform
        options:
          - kubernetes
          - docker
          - aws_ecs
          - azure_aks
          - gcp_gke
        min_version: "1.20.0"
      
      - name: artifact_registry
        type: service
        description: Artifact storage
        options:
          - docker_registry
          - artifactory
          - nexus
        min_version: "2.0.0"
      
      - name: monitoring_service
        type: service
        description: Health monitoring
        options:
          - prometheus
          - datadog
          - new_relic
        min_version: "2.0.0"
    
    # Required Libraries
    required_libraries:
      - name: kubernetes
        version: ">=26.0.0"
        purpose: Kubernetes deployment
        optional: true
      
      - name: docker
        version: ">=6.0.0"
        purpose: Container management
        optional: true
      
      - name: terraform
        version: ">=1.0.0"
        purpose: Infrastructure as code
        optional: true
    
    # System Requirements
    system_requirements:
      cpu:
        min_cores: 2
        recommended_cores: 4
      memory:
        min_gb: 4
        recommended_gb: 8
      storage:
        min_gb: 20
        recommended_gb: 100
  
  # Configuration
  configuration:
    # Promotion Settings
    promotion:
      require_approval: true
      min_approvers: 2
      approval_timeout_hours: 24
      auto_promote_on_success: false
    
    # Deployment Settings
    deployment:
      default_strategy: rolling_update
      health_check_timeout_seconds: 300
      health_check_interval_seconds: 10
      rollback_on_failure: true
    
    # Canary Settings
    canary:
      initial_traffic_percent: 10
      increment_percent: 10
      increment_interval_seconds: 300
      success_threshold_percent: 95
    
    # Rollback Settings
    rollback:
      automatic_rollback_enabled: true
      error_rate_threshold: 0.05
      latency_p95_threshold_ms: 1000
      availability_threshold: 0.99
  
  # Lifecycle
  lifecycle:
    # Initialization
    initialization:
      steps:
        - name: connect_deployment_platform
          description: Connect to deployment platform
          timeout_seconds: 60
        
        - name: connect_artifact_registry
          description: Connect to artifact registry
          timeout_seconds: 30
        
        - name: initialize_monitoring
          description: Initialize health monitoring
          timeout_seconds: 30
        
        - name: load_deployment_configs
          description: Load deployment configurations
          timeout_seconds: 60
    
    # Health Checks
    health_checks:
      liveness:
        endpoint: /health/live
        interval_seconds: 30
        timeout_seconds: 5
        failure_threshold: 3
      
      readiness:
        endpoint: /health/ready
        interval_seconds: 10
        timeout_seconds: 5
        failure_threshold: 3
      
      startup:
        endpoint: /health/startup
        interval_seconds: 10
        timeout_seconds: 5
        failure_threshold: 30
    
    # Graceful Shutdown
    shutdown:
      grace_period_seconds: 60
      steps:
        - name: stop_accepting_promotions
          description: Stop accepting new promotions
        
        - name: complete_pending_promotions
          description: Complete in-flight promotions
          timeout_seconds: 300
        
        - name: save_state
          description: Save promotion state
        
        - name: close_connections
          description: Close all connections
  
  # Monitoring
  monitoring:
    # Metrics
    metrics:
      enabled: true
      export_format: prometheus
      export_port: 9096
      metrics_list:
        # Promotion Metrics
        - name: promotion_total
          type: counter
          description: Total promotions
          labels:
            - source_env
            - target_env
            - status
        
        - name: promotion_duration_seconds
          type: histogram
          description: Promotion duration
          buckets: [60, 300, 600, 1800, 3600]
        
        - name: promotion_approval_time_seconds
          type: histogram
          description: Time to approval
          buckets: [300, 1800, 3600, 14400, 86400]
        
        # Deployment Metrics
        - name: deployment_total
          type: counter
          description: Total deployments
          labels:
            - strategy
            - status
        
        - name: deployment_duration_seconds
          type: histogram
          description: Deployment duration
          buckets: [30, 60, 300, 600, 1800]
        
        # Rollback Metrics
        - name: rollback_total
          type: counter
          description: Total rollbacks
          labels:
            - reason
            - automatic
        
        - name: rollback_duration_seconds
          type: histogram
          description: Rollback duration
          buckets: [10, 30, 60, 300]
        
        # Health Metrics
        - name: deployment_health_score
          type: gauge
          description: Deployment health score
          labels:
            - deployment_id
    
    # Logging
    logging:
      enabled: true
      level: INFO
      format: json
      outputs:
        - stdout
        - file
      log_file_path: /var/log/promotion-engine/promotion.log
      log_rotation:
        max_size_mb: 100
        max_files: 10
        compress: true
    
    # Tracing
    tracing:
      enabled: true
      backend: opentelemetry
      sampling_rate: 0.1
      exporters:
        - jaeger
        - zipkin
  
  # Security
  security:
    # Authentication
    authentication:
      enabled: true
      methods:
        - api_key
        - jwt
        - oauth2
      token_validation:
        issuer: auth.example.com
        audience: promotion-engine
    
    # Authorization
    authorization:
      enabled: true
      model: rbac
      permissions:
        - promotion:create
        - promotion:read
        - promotion:approve
        - promotion:execute
        - promotion:rollback
        - deployment:create
        - deployment:read
        - promotion:admin
    
    # Rate Limiting
    rate_limiting:
      enabled: true
      default_limit: 100
      window_seconds: 60
      strategy: sliding_window
    
    # Deployment Security
    deployment_security:
      image_scanning: true
      vulnerability_checking: true
      policy_enforcement: true
      secret_management: true
  
  # Artifacts
  artifacts:
    input_artifacts:
      - promotion-plan
      - deployment-manifest
      - approval-request
    
    output_artifacts:
      - promoted-artifact
      - approval-record
      - deployment-status
      - health-report
    
    storage_artifacts:
      - promotion-history
      - deployment-configs
      - rollback-manifests
  
  # Integration
  integration:
    # Upstream Services
    upstream:
      - name: validation-engine
        protocol: rest
        purpose: Pre-promotion validation
      
      - name: artifact-registry
        protocol: rest
        purpose: Artifact retrieval
    
    # Downstream Services
    downstream:
      - name: deployment-platform
        protocol: rest
        purpose: Deployment execution
      
      - name: monitoring-service
        protocol: rest
        purpose: Health monitoring
      
      - name: notification-service
        protocol: rest
        purpose: Promotion notifications
    
    # Event Bus
    event_bus:
      enabled: true
      topics_published:
        - promotion.completed
        - deployment.completed
        - rollback.triggered
      topics_subscribed:
        - artifact.validated
        - approval.granted
  
  # Versioning
  versioning:
    api_version: v1
    backward_compatible: true
    deprecation_policy: 6_months
    migration_guide_url: https://docs.example.com/promotion-engine/migration
  
  # Documentation
  documentation:
    api_docs_url: https://docs.example.com/promotion-engine/api
    user_guide_url: https://docs.example.com/promotion-engine/guide
    examples_url: https://docs.example.com/promotion-engine/examples
    changelog_url: https://docs.example.com/promotion-engine/changelog

# Metadata
metadata:
  created_at: "2025-01-11T00:00:00Z"
  updated_at: "2025-01-11T00:00:00Z"
  maintainers:
    - team:platform
    - team:deployment-team
  tags:
    - promotion
    - deployment
    - release
    - rollback
  status: active