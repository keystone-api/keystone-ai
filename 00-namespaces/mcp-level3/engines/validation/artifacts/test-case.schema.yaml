# MCP Level 3 - Validation Engine: Test Case Schema
# Purpose: Define test cases for validation, quality assurance, and regression testing
# Version: 1.0.0
# Last Updated: 2025-01-11

schema:
  name: test-case
  version: "1.0.0"
  namespace: mcp.level3.validation.artifacts
  description: |
    Test case artifact for defining validation tests, quality checks, and regression tests.
    Supports unit tests, integration tests, end-to-end tests, and property-based tests.
    Enables automated testing, continuous validation, and quality assurance.

  type: object
  required:
    - test_id
    - name
    - type
    - test_data
    - expected_result
    - created_at
  
  properties:
    # Core Identity
    test_id:
      type: string
      format: uuid
      description: Unique test case identifier
      example: "550e8400-e29b-41d4-a716-446655440000"
      index: true
    
    name:
      type: string
      description: Test case name
      example: "test_artifact_validation_with_valid_metadata"
      minLength: 3
      maxLength: 200
      pattern: '^[a-z][a-z0-9_]*$'
    
    title:
      type: string
      description: Human-readable title
      example: "Artifact Validation with Valid Metadata"
      maxLength: 200
      optional: true
    
    description:
      type: string
      description: Detailed test description
      example: "Verify that artifact validation succeeds with valid metadata structure"
      maxLength: 2000
      optional: true
    
    # Test Type
    type:
      type: string
      enum:
        - unit
        - integration
        - end_to_end
        - performance
        - security
        - regression
        - smoke
        - acceptance
        - property_based
        - fuzz
      description: Test type
      example: "unit"
    
    category:
      type: string
      description: Test category
      example: "validation"
      optional: true
    
    # Test Target
    target:
      type: object
      description: What is being tested
      required:
        - type
        - id
      properties:
        type:
          type: string
          enum:
            - artifact
            - component
            - service
            - api
            - pipeline
            - model
            - schema
            - function
          description: Target type
          example: "schema"
        
        id:
          type: string
          description: Target identifier
          example: "schema:artifact-metadata"
        
        version:
          type: string
          description: Target version
          example: "1.0.0"
          optional: true
        
        endpoint:
          type: string
          description: API endpoint or function name
          example: "/api/v1/validate"
          optional: true
    
    # Test Data
    test_data:
      type: object
      description: Input data for the test
      required:
        - input
      properties:
        input:
          description: Test input data
          additionalProperties: true
          example:
            artifact_id: "770e8400-e29b-41d4-a716-446655440001"
            name: "test-artifact"
            version: "1.0.0"
            type: "model"
        
        context:
          type: object
          description: Test execution context
          additionalProperties: true
          optional: true
          example:
            environment: "test"
            user: "test-user"
        
        fixtures:
          type: array
          description: Test fixtures/dependencies
          items:
            type: object
            properties:
              name:
                type: string
                description: Fixture name
              type:
                type: string
                description: Fixture type
              data:
                description: Fixture data
                additionalProperties: true
          optional: true
        
        mocks:
          type: array
          description: Mocked dependencies
          items:
            type: object
            properties:
              target:
                type: string
                description: What to mock
              behavior:
                type: string
                description: Mock behavior
              response:
                description: Mock response
                additionalProperties: true
          optional: true
    
    # Expected Result
    expected_result:
      type: object
      description: Expected test outcome
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether test should succeed
          example: true
        
        output:
          description: Expected output data
          additionalProperties: true
          optional: true
          example:
            valid: true
            errors: []
        
        status_code:
          type: integer
          description: Expected HTTP status code (for API tests)
          example: 200
          optional: true
        
        error:
          type: object
          description: Expected error (for negative tests)
          optional: true
          properties:
            code:
              type: string
              description: Error code
            message:
              type: string
              description: Error message
            type:
              type: string
              description: Error type
        
        assertions:
          type: array
          description: Specific assertions to verify
          items:
            type: object
            properties:
              type:
                type: string
                enum:
                  - equals
                  - not_equals
                  - contains
                  - not_contains
                  - greater_than
                  - less_than
                  - matches_pattern
                  - has_property
                  - is_type
                description: Assertion type
              path:
                type: string
                description: JSON path to value
                example: "$.metadata.accuracy"
              expected:
                description: Expected value
              message:
                type: string
                description: Assertion failure message
          optional: true
        
        performance:
          type: object
          description: Performance expectations
          optional: true
          properties:
            max_duration_ms:
              type: integer
              minimum: 0
              description: Maximum execution time in milliseconds
              example: 1000
            max_memory_mb:
              type: integer
              minimum: 0
              description: Maximum memory usage in MB
              example: 512
            max_cpu_percent:
              type: number
              minimum: 0
              maximum: 100
              description: Maximum CPU usage percentage
              example: 80
    
    # Test Configuration
    configuration:
      type: object
      description: Test execution configuration
      optional: true
      properties:
        timeout:
          type: integer
          minimum: 1
          description: Test timeout in seconds
          example: 30
          default: 30
        
        retry:
          type: object
          description: Retry configuration
          optional: true
          properties:
            max_attempts:
              type: integer
              minimum: 1
              description: Maximum retry attempts
              example: 3
              default: 1
            delay_ms:
              type: integer
              minimum: 0
              description: Delay between retries in milliseconds
              example: 1000
        
        parallel:
          type: boolean
          description: Whether test can run in parallel
          default: true
        
        dependencies:
          type: array
          description: Test dependencies (must run before this test)
          items:
            type: string
            format: uuid
          optional: true
        
        tags:
          type: array
          items:
            type: string
          description: Test tags for filtering
          example:
            - "smoke"
            - "critical"
          optional: true
        
        skip_conditions:
          type: array
          description: Conditions under which to skip test
          items:
            type: object
            properties:
              condition:
                type: string
                description: Skip condition expression
              reason:
                type: string
                description: Reason for skipping
          optional: true
    
    # Test Execution History
    executions:
      type: array
      description: Test execution history
      items:
        type: object
        properties:
          execution_id:
            type: string
            format: uuid
            description: Execution identifier
          
          status:
            type: string
            enum:
              - passed
              - failed
              - skipped
              - error
              - timeout
            description: Execution status
          
          started_at:
            type: string
            format: date-time
            description: Execution start time
          
          completed_at:
            type: string
            format: date-time
            description: Execution completion time
          
          duration_ms:
            type: integer
            minimum: 0
            description: Execution duration in milliseconds
          
          actual_result:
            type: object
            description: Actual test result
            additionalProperties: true
          
          error:
            type: object
            description: Error information if failed
            optional: true
            properties:
              message:
                type: string
              stack_trace:
                type: string
              details:
                type: object
                additionalProperties: true
          
          environment:
            type: object
            description: Execution environment
            optional: true
            properties:
              platform:
                type: string
              runtime:
                type: string
              version:
                type: string
      optional: true
    
    # Test Metrics
    metrics:
      type: object
      description: Test quality metrics
      optional: true
      properties:
        total_runs:
          type: integer
          minimum: 0
          description: Total number of executions
          example: 150
        
        pass_count:
          type: integer
          minimum: 0
          description: Number of passed executions
          example: 145
        
        fail_count:
          type: integer
          minimum: 0
          description: Number of failed executions
          example: 5
        
        pass_rate:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: Pass rate (0-1)
          example: 0.967
        
        avg_duration_ms:
          type: integer
          minimum: 0
          description: Average execution duration in milliseconds
          example: 250
        
        last_passed_at:
          type: string
          format: date-time
          description: Last successful execution
          optional: true
        
        last_failed_at:
          type: string
          format: date-time
          description: Last failed execution
          optional: true
        
        flakiness_score:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: Test flakiness score (0=stable, 1=very flaky)
          example: 0.05
          optional: true
    
    # Status
    status:
      type: string
      enum:
        - active
        - disabled
        - deprecated
        - archived
      description: Test case status
      example: "active"
      default: "active"
    
    priority:
      type: string
      enum:
        - critical
        - high
        - medium
        - low
      description: Test priority
      example: "high"
      default: "medium"
    
    # Metadata
    metadata:
      type: object
      description: Additional metadata
      optional: true
      properties:
        author:
          type: string
          description: Test author
          example: "john.doe@example.com"
        
        owner:
          type: string
          description: Test owner/maintainer
          example: "team:qa"
        
        suite:
          type: string
          description: Test suite name
          example: "artifact-validation-suite"
        
        jira_ticket:
          type: string
          description: Related JIRA ticket
          example: "TEST-1234"
          optional: true
        
        documentation_url:
          type: string
          format: uri
          description: Test documentation URL
          optional: true
        
        tags:
          type: array
          items:
            type: string
          description: Classification tags
          example:
            - "validation"
            - "regression"
            - "critical"
        
        custom:
          type: object
          description: Custom metadata
          additionalProperties: true
    
    # Timestamps
    created_at:
      type: string
      format: date-time
      description: Creation timestamp
      example: "2025-01-01T00:00:00Z"
      index: true
    
    updated_at:
      type: string
      format: date-time
      description: Last update timestamp
      example: "2025-01-11T10:00:00Z"
      optional: true
    
    last_executed_at:
      type: string
      format: date-time
      description: Last execution timestamp
      example: "2025-01-11T09:30:00Z"
      optional: true

  # Validation Rules
  validation:
    rules:
      - name: valid_name_format
        condition: name matches pattern
        message: "Name must be lowercase with underscores"
        severity: error
      
      - name: test_data_not_empty
        condition: test_data.input is not empty
        message: "Test input data cannot be empty"
        severity: error
      
      - name: valid_timeout
        condition: configuration.timeout == null || configuration.timeout > 0
        message: "Timeout must be positive"
        severity: error
      
      - name: valid_dependencies
        condition: all_dependencies_exist()
        message: "All test dependencies must reference existing tests"
        severity: error

  # Indexes
  indexes:
    - fields: [test_id]
      unique: true
    - fields: [name]
    - fields: [type, status]
    - fields: [target.type, target.id]
    - fields: [created_at]

# Usage Examples
examples:
  - name: unit_test_artifact_validation
    description: Unit test for artifact metadata validation
    data:
      test_id: "550e8400-e29b-41d4-a716-446655440000"
      name: "test_artifact_validation_with_valid_metadata"
      title: "Artifact Validation with Valid Metadata"
      description: "Verify that artifact validation succeeds with valid metadata structure"
      type: "unit"
      category: "validation"
      target:
        type: "schema"
        id: "schema:artifact-metadata"
        version: "1.0.0"
      test_data:
        input:
          artifact_id: "770e8400-e29b-41d4-a716-446655440001"
          name: "test-artifact"
          version: "1.0.0"
          type: "model"
          tags:
            - "test"
          metadata:
            framework: "pytorch"
        context:
          environment: "test"
          user: "test-user"
      expected_result:
        success: true
        output:
          valid: true
          errors: []
        assertions:
          - type: "equals"
            path: "$.valid"
            expected: true
            message: "Validation should succeed"
          - type: "equals"
            path: "$.errors.length"
            expected: 0
            message: "Should have no errors"
      configuration:
        timeout: 30
        parallel: true
        tags:
          - "smoke"
          - "critical"
      status: "active"
      priority: "high"
      metrics:
        total_runs: 150
        pass_count: 150
        fail_count: 0
        pass_rate: 1.0
        avg_duration_ms: 45
        flakiness_score: 0.0
      metadata:
        author: "john.doe@example.com"
        owner: "team:qa"
        suite: "artifact-validation-suite"
        tags:
          - "validation"
          - "regression"
          - "critical"
      created_at: "2025-01-01T00:00:00Z"
      updated_at: "2025-01-11T10:00:00Z"
      last_executed_at: "2025-01-11T09:30:00Z"

  - name: negative_test_invalid_version
    description: Negative test for invalid version format
    data:
      test_id: "660e8400-e29b-41d4-a716-446655440002"
      name: "test_artifact_validation_with_invalid_version"
      title: "Artifact Validation with Invalid Version"
      description: "Verify that validation fails with invalid version format"
      type: "unit"
      category: "validation"
      target:
        type: "schema"
        id: "schema:artifact-metadata"
        version: "1.0.0"
      test_data:
        input:
          artifact_id: "770e8400-e29b-41d4-a716-446655440003"
          name: "test-artifact"
          version: "invalid-version"
          type: "model"
      expected_result:
        success: false
        output:
          valid: false
        error:
          code: "VALIDATION_ERROR"
          message: "Version must follow semantic versioning (x.y.z)"
          type: "ValidationError"
        assertions:
          - type: "equals"
            path: "$.valid"
            expected: false
            message: "Validation should fail"
          - type: "contains"
            path: "$.errors[0].message"
            expected: "version"
            message: "Error should mention version"
      configuration:
        timeout: 30
        parallel: true
        tags:
          - "negative"
          - "validation"
      status: "active"
      priority: "high"
      created_at: "2025-01-01T00:00:00Z"

  - name: performance_test_bulk_validation
    description: Performance test for bulk validation
    data:
      test_id: "770e8400-e29b-41d4-a716-446655440004"
      name: "test_bulk_validation_performance"
      title: "Bulk Validation Performance Test"
      description: "Verify that bulk validation completes within performance limits"
      type: "performance"
      category: "validation"
      target:
        type: "api"
        id: "validation-service"
        endpoint: "/api/v1/validate/bulk"
      test_data:
        input:
          artifacts:
            - artifact_id: "880e8400-e29b-41d4-a716-446655440005"
              name: "artifact-1"
              version: "1.0.0"
              type: "model"
            # ... 99 more artifacts
      expected_result:
        success: true
        status_code: 200
        performance:
          max_duration_ms: 5000
          max_memory_mb: 512
          max_cpu_percent: 80
      configuration:
        timeout: 10
        parallel: false
        tags:
          - "performance"
          - "bulk"
      status: "active"
      priority: "medium"
      created_at: "2025-01-01T00:00:00Z"

# Integration Guidelines
integration:
  creation:
    - Define clear test objectives
    - Use descriptive names
    - Include comprehensive test data
    - Specify expected results precisely
    - Add relevant assertions
  
  execution:
    - Run tests in isolation
    - Handle setup and teardown
    - Capture detailed results
    - Log execution details
    - Report failures clearly
  
  maintenance:
    - Review flaky tests regularly
    - Update tests with code changes
    - Remove obsolete tests
    - Refactor duplicated logic
    - Document test purposes

# Performance Considerations
performance:
  execution:
    - Parallelize independent tests
    - Use test fixtures efficiently
    - Implement proper cleanup
    - Cache test data when possible
  
  storage:
    - Index on test_id and name
    - Archive old execution history
    - Compress large test data
    - Implement retention policies
  
  reporting:
    - Aggregate metrics efficiently
    - Cache test results
    - Use incremental updates
    - Optimize query patterns