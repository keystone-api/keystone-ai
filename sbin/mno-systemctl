#!/bin/bash
# MachineNativeOps 系統控制工具
# 版本: v1.0.0
# 用途: 系統服務管理和控制

set -euo pipefail

# 腳本目錄
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# 顏色定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 日誌函數
log_info() {
    echo -e "${BLUE}[SYSTEMCTL]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SYSTEMCTL]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[SYSTEMCTL]${NC} $1"
}

log_error() {
    echo -e "${RED}[SYSTEMCTL]${NC} $1"
}

# 服務狀態檢查
check_service_status() {
    local service="$1"
    local pid_file="var/run/machine-native-ops/${service}.pid"
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            echo "running"
        else
            echo "stopped"
        fi
    else
        echo "stopped"
    fi
}

# 啟動服務
start_service() {
    local service="$1"
    local status=$(check_service_status "$service")
    
    if [ "$status" = "running" ]; then
        log_warning "服務 $service 已經在運行"
        return 0
    fi
    
    log_info "啟動服務: $service"
    
    # 創建 PID 目錄
    mkdir -p "var/run/machine-native-ops"
    
    # 根據服務類型啟動
    case "$service" in
        engine)
            # 啟動 AAPS 引擎
            nohup python3 -m machinenativeops.engine > "var/log/machine-native-ops/engine.log" 2>&1 &
            echo $! > "var/run/machine-native-ops/engine.pid"
            ;;
        monitoring)
            # 啟動監控服務
            nohup python3 -m machinenativeops.monitoring > "var/log/machine-native-ops/monitoring.log" 2>&1 &
            echo $! > "var/run/machine-native-ops/monitoring.pid"
            ;;
        *)
            log_error "未知服務: $service"
            return 1
            ;;
    esac
    
    log_success "服務 $service 啟動成功"
}

# 停止服務
stop_service() {
    local service="$1"
    local status=$(check_service_status "$service")
    
    if [ "$status" = "stopped" ]; then
        log_warning "服務 $service 已經停止"
        return 0
    fi
    
    log_info "停止服務: $service"
    
    local pid_file="var/run/machine-native-ops/${service}.pid"
    local pid=$(cat "$pid_file")
    
    if kill "$pid" 2>/dev/null; then
        # 等待進程停止
        local count=0
        while kill -0 "$pid" 2>/dev/null && [ $count -lt 10 ]; do
            sleep 1
            count=$((count + 1))
        done
        
        if kill -0 "$pid" 2>/dev/null; then
            log_warning "強制終止服務 $service"
            kill -9 "$pid" 2>/dev/null || true
        fi
        
        rm -f "$pid_file"
        log_success "服務 $service 停止成功"
    else
        log_error "無法停止服務 $service"
        return 1
    fi
}

# 重啟服務
restart_service() {
    local service="$1"
    log_info "重啟服務: $service"
    stop_service "$service"
    sleep 2
    start_service "$service"
}

# 顯示服務狀態
show_status() {
    local services=("engine" "monitoring")
    
    echo "MachineNativeOps 服務狀態:"
    echo "=========================="
    
    for service in "${services[@]}"; do
        local status=$(check_service_status "$service")
        case "$status" in
            running)
                echo -e "$service: ${GREEN}運行中${NC}"
                ;;
            stopped)
                echo -e "$service: ${RED}已停止${NC}"
                ;;
        esac
    done
}

# 顯示幫助資訊
show_help() {
    cat << EOF
MachineNativeOps 系統控制工具 v1.0.0

用法: mno-systemctl <命令> <服務名>

命令:
    start       啟動服務
    stop        停止服務
    restart     重啟服務
    status      顯示服務狀態

服務:
    engine      AAPS 核心引擎
    monitoring  監控服務

範例:
    mno-systemctl start engine
    mno-systemctl stop monitoring
    mno-systemctl status
    mno-systemctl restart engine
EOF
}

# 主函數
main() {
    local command="${1:-}"
    local service="${2:-}"
    
    case "$command" in
        -h|--help)
            show_help
            exit 0
            ;;
        start)
            if [ -z "$service" ]; then
                log_error "請指定服務名稱"
                show_help
                exit 1
            fi
            start_service "$service"
            ;;
        stop)
            if [ -z "$service" ]; then
                log_error "請指定服務名稱"
                show_help
                exit 1
            fi
            stop_service "$service"
            ;;
        restart)
            if [ -z "$service" ]; then
                log_error "請指定服務名稱"
                show_help
                exit 1
            fi
            restart_service "$service"
            ;;
        status)
            show_status
            ;;
        *)
            log_error "未知命令: $command"
            show_help
            exit 1
            ;;
    esac
}

# 執行主函數
main "$@"