%YAML 1.2
---
# ═══════════════════════════════════════════════════════════════════════════════
#                    QUANTUM FLOW REFACTOR PLAYBOOK
#                    量子流重構劇本 - 三階段無縫執行
# ═══════════════════════════════════════════════════════════════════════════════

apiVersion: playbooks.machinenativeops/v2
kind: QuantumFlowPlaybook
metadata:
  name: quantum_flow_refactor
  version: "2.0.0"
  description: |
    Holy Grail's signature three-phase refactoring playbook:
    解構 (Deconstruct) → 整合 (Integrate) → 重構 (Refactor)

    Powered by:
    - AXIOM Dissolved (59 MCP tools)
    - INSTANT Execution (<3 minutes)
    - 64-256 Parallel Agents
    - Zero Human Intervention

spec:
  template_engine: "variable_substitution"
  execution_mode: "INSTANT"

  triggers:
    - on_startup: false
    - event: "REFACTOR_TRIGGERED"
    - event: "QUANTUM_FLOW_INITIATED"
    - event: "GRAIL_QUEST_STARTED"
    - event: "CODE_CHANGE_DETECTED"

  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 1: DECONSTRUCTION (解構)
  # ═══════════════════════════════════════════════════════════════════════════
  phases:
    - id: "phase_1_deconstruct"
      name: "解構 - Deconstruction"
      description: "Analyze legacy, extract patterns, identify dependencies"
      max_latency_ms: 30000
      parallelism: 64

      steps:
        - id: "load_dissolution_manifest"
          action: "mcp.manifest.load"
          description: "Load AXIOM dissolution manifest"
          inputs:
            path: "teams/holy-grail/dissolved-assets/AXIOM_DISSOLVED_INTEGRATION_MANIFEST.yaml"
          outputs:
            - dissolution_config

        - id: "analyze_legacy_codebase"
          action: "agents.invoke"
          description: "Analyze existing codebase using cognitive tools"
          agent_id: "axiom.cognitive"
          depends_on: ["load_dissolution_manifest"]
          inputs:
            tools:
              - cognitive_analysis
              - pattern_recognition
              - semantic_processor
            target: "${context.target_path}"
            depth: "comprehensive"
          outputs:
            - legacy_analysis
          artifacts:
            - name: "legacy_analysis_report"
              type: "markdown"

        - id: "extract_patterns"
          action: "agents.invoke"
          description: "Extract reusable patterns from legacy code"
          agent_id: "axiom.reasoning"
          depends_on: ["analyze_legacy_codebase"]
          inputs:
            tools:
              - knowledge_graph
              - inference_engine
              - logical_reasoning
            analysis: "${legacy_analysis}"
          outputs:
            - extracted_patterns
          artifacts:
            - name: "pattern_catalog"
              type: "yaml"

        - id: "map_dependencies"
          action: "agents.invoke"
          description: "Create comprehensive dependency map"
          agent_id: "ai.architect"
          depends_on: ["analyze_legacy_codebase"]
          parallel_with: ["extract_patterns"]
          inputs:
            analysis: "${legacy_analysis}"
            depth: "deep"
          outputs:
            - dependency_graph
          artifacts:
            - name: "dependency_map"
              type: "json"

        - id: "assess_risks"
          action: "agents.invoke"
          description: "Assess refactoring risks"
          agent_id: "ai.security"
          depends_on: ["map_dependencies", "extract_patterns"]
          inputs:
            dependencies: "${dependency_graph}"
            patterns: "${extracted_patterns}"
          outputs:
            - risk_assessment
          artifacts:
            - name: "risk_assessment_report"
              type: "markdown"

    # ═══════════════════════════════════════════════════════════════════════════
    # PHASE 2: INTEGRATION (整合)
    # ═══════════════════════════════════════════════════════════════════════════
    - id: "phase_2_integrate"
      name: "整合 - Integration"
      description: "Design new architecture, map flows, create contracts"
      max_latency_ms: 60000
      parallelism: 128
      depends_on: ["phase_1_deconstruct"]

      steps:
        - id: "design_target_architecture"
          action: "agents.invoke"
          description: "Design the target architecture"
          agent_id: "axiom.governance"
          inputs:
            tools:
              - architecture_plan
              - system_governance
            legacy_analysis: "${legacy_analysis}"
            patterns: "${extracted_patterns}"
            constraints: "${risk_assessment}"
          outputs:
            - target_architecture
          artifacts:
            - name: "target_architecture_spec"
              type: "yaml"

        - id: "create_migration_contracts"
          action: "agents.invoke"
          description: "Create migration contracts and interfaces"
          agent_id: "axiom.reasoning"
          depends_on: ["design_target_architecture"]
          inputs:
            tools:
              - api_orchestrator
              - workflow_engine
            source_architecture: "${dependency_graph}"
            target_architecture: "${target_architecture}"
          outputs:
            - migration_contracts
          artifacts:
            - name: "migration_contracts"
              type: "typescript"

        - id: "plan_data_flow_migration"
          action: "agents.invoke"
          description: "Plan data flow transformations"
          agent_id: "ai.data-scientist"
          depends_on: ["design_target_architecture"]
          parallel_with: ["create_migration_contracts"]
          inputs:
            source: "${dependency_graph}"
            target: "${target_architecture}"
          outputs:
            - data_flow_plan
          artifacts:
            - name: "data_flow_migration_plan"
              type: "markdown"

        - id: "generate_integration_tests"
          action: "agents.invoke"
          description: "Generate integration test suite"
          agent_id: "ai.qa"
          depends_on: ["create_migration_contracts"]
          inputs:
            contracts: "${migration_contracts}"
            architecture: "${target_architecture}"
          outputs:
            - integration_tests
          artifacts:
            - name: "integration_test_suite"
              type: "code"

    # ═══════════════════════════════════════════════════════════════════════════
    # PHASE 3: REFACTORING (重構)
    # ═══════════════════════════════════════════════════════════════════════════
    - id: "phase_3_refactor"
      name: "重構 - Refactoring"
      description: "Execute transformation, validate, deploy"
      max_latency_ms: 90000
      parallelism: 256
      depends_on: ["phase_2_integrate"]

      steps:
        - id: "execute_code_transformation"
          action: "agents.invoke"
          description: "Execute the actual code transformation"
          agent_id: "instant.code-generation"
          inputs:
            source_code: "${context.target_path}"
            target_architecture: "${target_architecture}"
            contracts: "${migration_contracts}"
            patterns: "${extracted_patterns}"
          outputs:
            - transformed_code
          artifacts:
            - name: "transformed_codebase"
              type: "code"

        - id: "optimize_performance"
          action: "agents.invoke"
          description: "Optimize the transformed code"
          agent_id: "axiom.governance"
          depends_on: ["execute_code_transformation"]
          inputs:
            tools:
              - performance_tuner
              - resource_optimizer
              - system_optimization
            code: "${transformed_code}"
          outputs:
            - optimized_code
          artifacts:
            - name: "optimization_report"
              type: "markdown"

        - id: "validate_transformation"
          action: "agents.invoke"
          description: "Validate the transformation meets requirements"
          agent_id: "axiom.governance"
          depends_on: ["optimize_performance"]
          inputs:
            tools:
              - compliance_monitor
              - policy_engine
              - audit_logger
            original: "${context.target_path}"
            transformed: "${optimized_code}"
            tests: "${integration_tests}"
          outputs:
            - validation_result
          artifacts:
            - name: "validation_report"
              type: "markdown"

        - id: "security_scan"
          action: "agents.invoke"
          description: "Security scan of transformed code"
          agent_id: "ai.security"
          depends_on: ["optimize_performance"]
          parallel_with: ["validate_transformation"]
          inputs:
            code: "${optimized_code}"
            scan_type: "comprehensive"
          outputs:
            - security_report
          artifacts:
            - name: "security_scan_report"
              type: "markdown"

        - id: "deploy_transformation"
          action: "agents.invoke"
          description: "Deploy the transformed code"
          agent_id: "instant.deployment"
          depends_on: ["validate_transformation", "security_scan"]
          inputs:
            code: "${optimized_code}"
            validation: "${validation_result}"
            security: "${security_report}"
            strategy: "blue-green"
          outputs:
            - deployment_result
          artifacts:
            - name: "deployment_report"
              type: "markdown"

  # ═══════════════════════════════════════════════════════════════════════════
  # COMPLETION AND AUDIT
  # ═══════════════════════════════════════════════════════════════════════════
  completion:
    - id: "emit_completion_event"
      action: "events.emit"
      description: "Emit quantum flow completion event"
      depends_on: ["phase_3_refactor"]
      inputs:
        event_type: "QUANTUM_FLOW_COMPLETED"
        payload:
          team_id: "holy-grail"
          playbook: "quantum_flow_refactor"
          phases_completed: ["deconstruct", "integrate", "refactor"]
          total_latency: "${execution.total_latency_ms}"
          artifacts_generated: "${execution.artifacts_count}"

    - id: "generate_final_report"
      action: "agents.invoke"
      description: "Generate comprehensive final report"
      agent_id: "axiom.governance"
      depends_on: ["emit_completion_event"]
      inputs:
        tools:
          - output_quality
          - format_optimizer
        all_artifacts: "${execution.all_artifacts}"
        metrics: "${execution.metrics}"
      outputs:
        - final_report
      artifacts:
        - name: "quantum_flow_final_report"
          type: "markdown"

  # ═══════════════════════════════════════════════════════════════════════════
  # AUDIT CONFIGURATION
  # ═══════════════════════════════════════════════════════════════════════════
  audit:
    enabled: true
    log_path: "audit/quantum-flow-events.jsonl"
    events:
      - "PLAYBOOK_STARTED"
      - "PHASE_STARTED"
      - "PHASE_COMPLETED"
      - "STEP_STARTED"
      - "STEP_COMPLETED"
      - "ARTIFACT_GENERATED"
      - "PLAYBOOK_COMPLETED"
      - "ERROR"
    retention_days: 90

  # ═══════════════════════════════════════════════════════════════════════════
  # AUTO-HEALING
  # ═══════════════════════════════════════════════════════════════════════════
  auto_healing:
    enabled: true
    strategies:
      - type: "retry_with_backoff"
        max_retries: 3
        initial_delay_ms: 1000
        backoff_multiplier: 2

      - type: "fallback_to_safe"
        trigger: "persistent_failure"
        action: "rollback_to_checkpoint"

      - type: "circuit_breaker"
        failure_threshold: 5
        recovery_timeout_ms: 30000
